<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Travel ‚Äî Service & Visa Hub</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-hover: #334155;
            --sidebar-active: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-item:hover {
            background: var(--sidebar-hover);
        }

        .sidebar-item.active {
            background: var(--sidebar-active);
            border-left: 3px solid white;
        }

        .sidebar-icon {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .role-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-badge {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .role-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .role-dropdown.show {
            display: block;
        }

        .role-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .role-option:hover {
            background: var(--bg-main);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-sublabel {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-main);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: var(--bg-main);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-main);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
        }

        /* Three Column Layout */
        .three-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .column {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-main);
        }

        .column-title {
            font-weight: 600;
            font-size: 16px;
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* List Items */
        .list-item {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: var(--primary);
            background: var(--bg-main);
        }

        .list-item.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .list-item-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-new { background: #dbeafe; color: #1e40af; }
        .status-preparing { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-flying { background: #e0e7ff; color: #3730a3; }
        .status-sent { background: #dcfce7; color: #166534; }

        /* Detail Card */
        .detail-card {
            padding: 0;
        }

        .detail-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .detail-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
        }

        .detail-info h3 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .detail-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .detail-section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Chart */
        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px;
        }

        .chart-bar {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .chart-bar-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        .chart-bar-value {
            font-size: 12px;
            font-weight: 600;
            color: white;
            padding: 4px;
        }

        /* Activity Log */
        .activity-item {
            padding: 12px;
            border-left: 3px solid var(--primary);
            background: var(--bg-main);
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .activity-text {
            font-size: 14px;
        }

        /* Calendar */
        .calendar-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .calendar {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-main);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
        }

        .calendar-day.selected.has-event::after {
            background: white;
        }

        .events-panel {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
        }

        .event-item {
            padding: 12px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .event-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .event-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .three-column-layout {
                grid-template-columns: 1fr;
            }
            
            .column {
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Atlas Travel</div>
                <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Service & Visa Hub</div>
            </div>
            <nav class="sidebar-menu">
                <div class="sidebar-item active" onclick="showPage('dashboard')">
                    <span class="sidebar-icon">üìä</span>
                    <span>–î–∞—à–±–æ—Ä–¥</span>
                </div>
                <div class="sidebar-item" onclick="showPage('groups')">
                    <span class="sidebar-icon">üë•</span>
                    <span>–ì—Ä—É–ø–ø—ã –∏ –ø–∞–ª–æ–º–Ω–∏–∫–∏</span>
                </div>
                <div class="sidebar-item" onclick="showPage('templates')">
                    <span class="sidebar-icon">üí¨</span>
                    <span>–®–∞–±–ª–æ–Ω—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('managers')">
                    <span class="sidebar-icon">üë§</span>
                    <span>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('schedule')">
                    <span class="sidebar-icon">üìÖ</span>
                    <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                </div>
                <div class="sidebar-item" onclick="showPage('documents')">
                    <span class="sidebar-icon">üìÑ</span>
                    <span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('settings')">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º</div>
                <div class="role-switcher">
                    <div class="role-badge" onclick="toggleRoleDropdown()">
                        –†–æ–ª—å: <span id="currentRole">–ê–¥–º–∏–Ω</span> ‚ñº
                        <div class="role-dropdown" id="roleDropdown">
                            <div class="role-option" onclick="switchRole('admin', '–ê–¥–º–∏–Ω')">–ê–¥–º–∏–Ω</div>
                            <div class="role-option" onclick="switchRole('service_manager', '–°–µ—Ä–≤–∏—Å')">–°–µ—Ä–≤–∏—Å</div>
                            <div class="role-option" onclick="switchRole('op', '–û–ü')">–û–ü</div>
                            <div class="role-option" onclick="switchRole('finance', '–§–∏–Ω–∞–Ω—Å—ã')">–§–∏–Ω–∞–Ω—Å—ã</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <section id="page-dashboard" class="page-section active">
                    <h2 style="margin-bottom: 24px;">–î–∞—à–±–æ—Ä–¥</h2>
                    
                    <!-- Metrics -->
                    <div class="metrics-grid" id="metricsGrid"></div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="openCreateGroupModal()">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                            </button>
                            <button class="btn btn-primary" onclick="openCreatePilgrimModal()">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–∞–ª–æ–º–Ω–∏–∫–∞
                            </button>
                            <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
                            </button>
                            <button class="btn btn-secondary" onclick="showPage('schedule')">
                                üìÖ –û—Ç–∫—Ä—ã—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                            </button>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="card">
                            <div class="card-header">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</div>
                            <div class="chart-container" id="statusChart"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">–î–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ —Ç–∏–ø–∞–º</div>
                            <div class="chart-container" id="documentsChart"></div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="card">
                        <div class="card-header">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div id="activityLog"></div>
                    </div>
                </section>

                <!-- Groups & Pilgrims Page -->
                <section id="page-groups" class="page-section">
                    <h2 style="margin-bottom: 24px;">–ì—Ä—É–ø–ø—ã –∏ –ø–∞–ª–æ–º–Ω–∏–∫–∏</h2>
                    <div class="three-column-layout">
                        <!-- Groups Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title">–ì—Ä—É–ø–ø—ã</div>
                                <button class="btn btn-primary btn-sm" onclick="openCreateGroupModal()">‚ûï</button>
                            </div>
                            <div class="column-content" id="groupsList"></div>
                        </div>

                        <!-- Pilgrims Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title">–ü–∞–ª–æ–º–Ω–∏–∫–∏</div>
                                <button class="btn btn-primary btn-sm" onclick="openCreatePilgrimModal()">‚ûï</button>
                            </div>
                            <div class="column-content" id="pilgrimsList"></div>
                        </div>

                        <!-- Pilgrim Detail Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title">–î–µ—Ç–∞–ª–∏ –ø–∞–ª–æ–º–Ω–∏–∫–∞</div>
                            </div>
                            <div class="column-content" id="pilgrimDetail"></div>
                        </div>
                    </div>
                </section>

                <!-- Templates Page -->
                <section id="page-templates" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                            <button class="btn btn-primary btn-sm" onclick="openCreateTemplateModal()">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
                            </button>
                        </div>
                        <div class="table-container" id="templatesTable"></div>
                    </div>
                </section>

                <!-- Managers Page -->
                <section id="page-managers" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                            <button class="btn btn-primary btn-sm" onclick="openCreateManagerModal()">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                            </button>
                        </div>
                        <div class="table-container" id="managersTable"></div>
                    </div>
                </section>

                <!-- Schedule Page -->
                <section id="page-schedule" class="page-section">
                    <h2 style="margin-bottom: 24px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤</h2>
                    <div class="calendar-container">
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">‚óÄ</button>
                                <div class="calendar-month" id="calendarMonth"></div>
                                <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)">‚ñ∂</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                        <div class="events-panel">
                            <h3 style="margin-bottom: 16px;">–°–æ–±—ã—Ç–∏—è –¥–Ω—è</h3>
                            <div id="eventsPanel"></div>
                        </div>
                    </div>
                </section>

                <!-- Documents Page -->
                <section id="page-documents" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                            <button class="btn btn-primary btn-sm" onclick="openUploadDocumentModal()">
                                ‚ûï –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                            </button>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <select class="form-select" id="filterDocType" onchange="renderDocumentsPage()">
                                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                    <option value="passport">–ü–∞—Å–ø–æ—Ä—Ç</option>
                                    <option value="visa">–í–∏–∑–∞</option>
                                    <option value="insurance">–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                                    <option value="ticket">–ë–∏–ª–µ—Ç</option>
                                    <option value="voucher">–í–∞—É—á–µ—Ä</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="filterDocStatus" onchange="renderDocumentsPage()">
                                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                    <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                                    <option value="ready_to_send">–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                                    <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container" id="documentsTable"></div>
                    </div>
                </section>

                <!-- Settings Page -->
                <section id="page-settings" class="page-section">
                    <h2 style="margin-bottom: 24px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                    
                    <div class="card">
                        <div class="card-header">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã</div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp API –∫–ª—é—á</label>
                            <input type="text" class="form-input" id="settingWhatsappKey" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp Endpoint</label>
                            <input type="text" class="form-input" id="settingWhatsappEndpoint" placeholder="https://api.whatsapp.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-input" id="settingTelegramToken" placeholder="–î–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">
                        </div>
                        <button class="btn btn-primary" onclick="testMessengerConnection()">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                        <div class="form-group">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è</label>
                            <input type="number" class="form-input" id="settingMinPasswordLength" value="8">
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="settingRequireSpecialChars" checked>
                            <label>–¢—Ä–µ–±–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –ø–∞—Ä–æ–ª–µ</label>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="saveSettings()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>

    <!-- Generic Modal -->
    <div class="modal" id="genericModal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="modalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // Global State
        let state = {
            currentRole: 'admin',
            currentRoleName: '–ê–¥–º–∏–Ω',
            selectedGroupId: null,
            selectedPilgrimId: null,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: null,
            users: [],
            service_groups: [],
            pilgrims: [],
            documents: [],
            payments: [],
            message_templates: [],
            message_logs: []
        };

        // Initialize Data
        function initData() {
            // Users
            state.users = [
                { id: 1, name: '–ù—É—Ä–ª–∞–Ω –ê–±–¥—É–ª–ª–∞–µ–≤', phone: '+77012345678', role: 'admin', created_at: '2024-01-15' },
                { id: 2, name: '–ê–π–≥—É–ª—å –°–∞–ø–∞—Ä–æ–≤–∞', phone: '+77012345679', role: 'service_manager', created_at: '2024-01-16' },
                { id: 3, name: '–ê–π—à–∞ –ö–∞—Å—ã–º–æ–≤–∞', phone: '+77012345680', role: 'op', created_at: '2024-01-17' },
                { id: 4, name: '–î–∞–º–∏—Ä –ò–±—Ä–∞–µ–≤', phone: '+77012345681', role: 'finance', created_at: '2024-01-18' },
                { id: 5, name: '–ì—É–ª—å–Ω–∞—Ä–∞ –û—Ä–∞–∑–æ–≤–∞', phone: '+77012345682', role: 'service_manager', created_at: '2024-02-01' }
            ];

            // Service Groups
            state.service_groups = [
                { id: 1, name: '–•–∞–¥–∂ 2025 - –ì—Ä—É–ø–ø–∞ 1', route: '–ú–µ–∫–∫–∞ - –ú–µ–¥–∏–Ω–∞', depart_date: '2025-06-10', return_date: '2025-06-25', status: 'preparing', created_at: '2024-11-01' },
                { id: 2, name: '–£–º—Ä–∞ –Ø–Ω–≤–∞—Ä—å 2025', route: '–ú–µ–∫–∫–∞ - –ú–µ–¥–∏–Ω–∞ - –î–∂–∏–¥–¥–∞', depart_date: '2025-01-15', return_date: '2025-01-22', status: 'flying', created_at: '2024-11-15' },
                { id: 3, name: '–£–º—Ä–∞ –î–µ–∫–∞–±—Ä—å 2024', route: '–ú–µ–∫–∫–∞', depart_date: '2024-12-20', return_date: '2024-12-27', status: 'new', created_at: '2024-11-20' }
            ];

            // Pilgrims
            state.pilgrims = [
                {
                    id: 1, group_id: 1, manager_id: 2, full_name: '–ê—Å—ã–ª—Ö–∞–Ω –ù—É—Ä–±–µ–∫–æ–≤', phone: '+77011111111', 
                    messenger: 'whatsapp', status: 'ready', depart_date: '2025-06-10', return_date: '2025-06-25',
                    hotel_name: 'Hilton Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', room_type: '–î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π', board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: '–ì—Ä—É–ø–ø–æ–≤–æ–π', tour_start_date: '2025-06-10', tour_end_date: '2025-06-25', tour_price_usd: 5500,
                    passport_number: 'N12345678', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', passport_birth_date: '1980-05-15',
                    passport_gender: '–ú', passport_issue_date: '2020-03-10', passport_expiry_date: '2030-03-10',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', passport_verified: true,
                    created_at: '2024-11-05', updated_at: '2024-12-01'
                },
                {
                    id: 2, group_id: 1, manager_id: 2, full_name: '–ñ–∞–Ω–∞—Ä–∞ –°–º–∞–≥—É–ª–æ–≤–∞', phone: '+77011111112',
                    messenger: 'whatsapp', status: 'training', depart_date: '2025-06-10', return_date: '2025-06-25',
                    hotel_name: 'Swissotel Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', room_type: '–û–¥–Ω–æ–º–µ—Å—Ç–Ω—ã–π', board_type: '–ó–∞–≤—Ç—Ä–∞–∫',
                    transfer_type: '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π', tour_start_date: '2025-06-10', tour_end_date: '2025-06-25', tour_price_usd: 6200,
                    passport_number: 'N23456789', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', passport_birth_date: '1975-08-20',
                    passport_gender: '–ñ', passport_issue_date: '2019-06-15', passport_expiry_date: '2029-06-15',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', passport_verified: false,
                    created_at: '2024-11-10', updated_at: '2024-11-28'
                },
                {
                    id: 3, group_id: 2, manager_id: 5, full_name: '–ï—Ä–±–æ–ª –ö–µ–Ω–∂–µ–±–∞–µ–≤', phone: '+77011111113',
                    messenger: 'whatsapp', status: 'flying', depart_date: '2025-01-15', return_date: '2025-01-22',
                    hotel_name: 'Pullman Zamzam', hotel_type: '5 –∑–≤–µ–∑–¥', room_type: '–î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π', board_type: '–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: '–ì—Ä—É–ø–ø–æ–≤–æ–π', tour_start_date: '2025-01-15', tour_end_date: '2025-01-22', tour_price_usd: 3800,
                    passport_number: 'N34567890', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', passport_birth_date: '1985-12-05',
                    passport_gender: '–ú', passport_issue_date: '2021-01-20', passport_expiry_date: '2031-01-20',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', passport_verified: true,
                    created_at: '2024-11-20', updated_at: '2024-12-05'
                }
            ];

            // Documents
            state.documents = [
                { id: 1, pilgrim_id: 1, type: 'passport', file_url: 'passport_1.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'ready_to_send', uploaded_by_user_id: 3, uploaded_at: '2024-11-05' },
                { id: 2, pilgrim_id: 1, type: 'visa', file_url: 'visa_1.pdf', original_name: '–í–∏–∑–∞ –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'sent', uploaded_by_user_id: 2, uploaded_at: '2024-11-20' },
                { id: 3, pilgrim_id: 1, type: 'insurance', file_url: 'insurance_1.pdf', original_name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'sent', uploaded_by_user_id: 2, uploaded_at: '2024-11-22' },
                { id: 4, pilgrim_id: 2, type: 'passport', file_url: 'passport_2.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ñ–∞–Ω–∞—Ä—ã.pdf', status: 'preparing', uploaded_by_user_id: 3, uploaded_at: '2024-11-10' },
                { id: 5, pilgrim_id: 3, type: 'passport', file_url: 'passport_3.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 3, uploaded_at: '2024-11-20' },
                { id: 6, pilgrim_id: 3, type: 'visa', file_url: 'visa_3.pdf', original_name: '–í–∏–∑–∞ –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 5, uploaded_at: '2024-12-01' },
                { id: 7, pilgrim_id: 3, type: 'ticket', file_url: 'ticket_3.pdf', original_name: '–ë–∏–ª–µ—Ç –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 5, uploaded_at: '2024-12-03' }
            ];

            // Payments
            state.payments = [
                { id: 1, pilgrim_id: 1, type: 'prepayment', amount_usd: 2000, paid_at: '2024-11-05', created_by_user_id: 3, comment: '–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' },
                { id: 2, pilgrim_id: 1, type: 'extra', amount_usd: 1500, paid_at: '2024-11-20', created_by_user_id: 4, comment: '–í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å –æ–ø–ª–∞—Ç—ã' },
                { id: 3, pilgrim_id: 1, type: 'extra', amount_usd: 2000, paid_at: '2024-12-01', created_by_user_id: 4, comment: '–§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞' },
                { id: 4, pilgrim_id: 2, type: 'prepayment', amount_usd: 3000, paid_at: '2024-11-10', created_by_user_id: 3, comment: '–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' },
                { id: 5, pilgrim_id: 3, type: 'prepayment', amount_usd: 1500, paid_at: '2024-11-20', created_by_user_id: 3, comment: '–ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å' },
                { id: 6, pilgrim_id: 3, type: 'extra', amount_usd: 2300, paid_at: '2024-12-05', created_by_user_id: 4, comment: '–ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞' }
            ];

            // Message Templates
            state.message_templates = [
                {
                    id: 1, name: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞', trigger_type: 'time_before_departure',
                    trigger_key: 'before_departure', offset_days: -7, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {name}! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π {depart_date} —Å–æ—Å—Ç–æ–∏—Ç—Å—è –≤–∞—à –≤—ã–ª–µ—Ç. –û—Ç–µ–ª—å: {hotel_name}. –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º: {manager_name}.',
                    variables: {}, can_attach_file: false, is_active: true, created_at: '2024-10-01'
                },
                {
                    id: 2, name: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–∑—ã', trigger_type: 'document_based',
                    trigger_key: 'visa_ready', offset_days: 0, offset_hours: 0, offset_minutes: 0,
                    document_type: 'visa', channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {name}! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É. –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–ª–∞–≥–∞–µ—Ç—Å—è.',
                    variables: {}, can_attach_file: true, is_active: true, created_at: '2024-10-05'
                },
                {
                    id: 3, name: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å –¥–æ –ø—Ä–∏–ª—ë—Ç–∞', trigger_type: 'time_before_arrival',
                    trigger_key: 'before_arrival', offset_days: -1, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {name}! –ó–∞–≤—Ç—Ä–∞ {return_date} –≤–∞—à —Ä–µ–π—Å –¥–æ–º–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –±–∞–≥–∞–∂.',
                    variables: {}, can_attach_file: false, is_active: true, created_at: '2024-10-10'
                },
                {
                    id: 4, name: '–†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', trigger_type: 'manual',
                    trigger_key: 'manual', offset_days: 0, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {name}! –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {manager_name}.',
                    variables: {}, can_attach_file: true, is_active: true, created_at: '2024-10-15'
                }
            ];

            // Message Logs
            state.message_logs = [
                {
                    id: 1, pilgrim_id: 1, template_id: 1, sent_by_user_id: null, channel: 'whatsapp',
                    status: 'sent', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, –ê—Å—ã–ª—Ö–∞–Ω –ù—É—Ä–±–µ–∫–æ–≤! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º...',
                    attachment_url: null, sent_at: '2024-12-03T10:00:00'
                },
                {
                    id: 2, pilgrim_id: 1, template_id: 2, sent_by_user_id: 2, channel: 'whatsapp',
                    status: 'delivered', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, –ê—Å—ã–ª—Ö–∞–Ω –ù—É—Ä–±–µ–∫–æ–≤! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞...',
                    attachment_url: 'visa_1.pdf', sent_at: '2024-11-20T14:30:00'
                },
                {
                    id: 3, pilgrim_id: 3, template_id: 2, sent_by_user_id: 5, channel: 'whatsapp',
                    status: 'sent', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, –ï—Ä–±–æ–ª –ö–µ–Ω–∂–µ–±–∞–µ–≤! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞...',
                    attachment_url: 'visa_3.pdf', sent_at: '2024-12-01T16:00:00'
                }
            ];
        }

        // Initialize UI
        function initUI() {
            initData();
            renderDashboard();
            renderGroupsAndPilgrims();
            renderTemplatesPage();
            renderManagersPage();
            renderSchedulePage();
            renderDocumentsPage();
        }

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById('page-' + pageId).classList.add('active');
            
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-item').classList.add('active');
            
            // Render page content
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'groups') renderGroupsAndPilgrims();
            if (pageId === 'templates') renderTemplatesPage();
            if (pageId === 'managers') renderManagersPage();
            if (pageId === 'schedule') renderSchedulePage();
            if (pageId === 'documents') renderDocumentsPage();
        }

        // Role Management
        function toggleRoleDropdown() {
            const dropdown = document.getElementById('roleDropdown');
            dropdown.classList.toggle('show');
        }

        function switchRole(role, roleName) {
            state.currentRole = role;
            state.currentRoleName = roleName;
            document.getElementById('currentRole').textContent = roleName;
            document.getElementById('roleDropdown').classList.remove('show');
            
            // Re-render current page to reflect role permissions
            const activePage = document.querySelector('.page-section.active');
            if (activePage.id === 'page-groups') {
                renderSelectedPilgrim();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.role-badge')) {
                document.getElementById('roleDropdown').classList.remove('show');
            }
        });

        // Dashboard
        function renderDashboard() {
            // Metrics
            const activeGroups = state.service_groups.filter(g => ['preparing', 'flying', 'in_trip'].includes(g.status)).length;
            const totalPilgrims = state.pilgrims.length;
            
            const pilgrimsNoVisa = state.pilgrims.filter(p => {
                return !state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa');
            }).length;
            
            const pilgrimsWithVisa = state.pilgrims.filter(p => {
                return state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status !== 'sent');
            }).length;
            
            const pilgrimsVisaSent = state.pilgrims.filter(p => {
                return state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status === 'sent');
            }).length;
            
            const totalPrepayments = state.payments.filter(p => p.type === 'prepayment').reduce((sum, p) => sum + p.amount_usd, 0);
            const totalExtra = state.payments.filter(p => p.type === 'extra').reduce((sum, p) => sum + p.amount_usd, 0);
            const totalTourPrice = state.pilgrims.reduce((sum, p) => sum + (p.tour_price_usd || 0), 0);
            const totalRemaining = totalTourPrice - totalPrepayments - totalExtra;
            
            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã</div>
                    <div class="metric-value">${activeGroups}</div>
                    <div class="metric-sublabel">–∏–∑ ${state.service_groups.length} –≤—Å–µ–≥–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ü–∞–ª–æ–º–Ω–∏–∫–∏</div>
                    <div class="metric-value">${totalPilgrims}</div>
                    <div class="metric-sublabel">–≤—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ë–µ–∑ –≤–∏–∑—ã</div>
                    <div class="metric-value" style="color: var(--danger);">${pilgrimsNoVisa}</div>
                    <div class="metric-sublabel">—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–í–∏–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>
                    <div class="metric-value" style="color: var(--warning);">${pilgrimsWithVisa}</div>
                    <div class="metric-sublabel">–≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–í–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
                    <div class="metric-value" style="color: var(--success);">${pilgrimsVisaSent}</div>
                    <div class="metric-sublabel">–ø–∞–ª–æ–º–Ω–∏–∫–∏ –≥–æ—Ç–æ–≤—ã</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç—ã</div>
                    <div class="metric-value" style="color: var(--success);">$${totalPrepayments.toLocaleString()}</div>
                    <div class="metric-sublabel">–ø–æ–ª—É—á–µ–Ω–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–î–æ–ø–ª–∞—Ç—ã</div>
                    <div class="metric-value" style="color: var(--success);">$${totalExtra.toLocaleString()}</div>
                    <div class="metric-sublabel">–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å</div>
                    <div class="metric-value" style="color: var(--warning);">$${totalRemaining.toLocaleString()}</div>
                    <div class="metric-sublabel">–∫ –ø–æ–ª—É—á–µ–Ω–∏—é</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = metricsHTML;
            
            // Status Chart
            const statusCounts = {
                'new': 0, 'training': 0, 'ready': 0, 'flying': 0, 'in_hotel': 0, 'rituals': 0, 'finished': 0
            };
            state.pilgrims.forEach(p => {
                if (statusCounts[p.status] !== undefined) statusCounts[p.status]++;
            });
            
            const maxCount = Math.max(...Object.values(statusCounts), 1);
            const statusLabels = {
                'new': '–ù–æ–≤—ã–π', 'training': '–û–±—É—á–µ–Ω–∏–µ', 'ready': '–ì–æ—Ç–æ–≤',
                'flying': '–õ–µ—Ç–∏—Ç', 'in_hotel': '–í –æ—Ç–µ–ª–µ', 'rituals': '–û–±—Ä—è–¥—ã', 'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω'
            };
            
            let chartHTML = '';
            for (const [status, count] of Object.entries(statusCounts)) {
                const height = (count / maxCount) * 150;
                chartHTML += `
                    <div class="chart-bar" style="height: ${height}px; background: var(--primary);">
                        <div class="chart-bar-value">${count}</div>
                        <div class="chart-bar-label">${statusLabels[status]}</div>
                    </div>
                `;
            }
            document.getElementById('statusChart').innerHTML = chartHTML;
            
            // Documents Chart
            const docCounts = {};
            state.documents.forEach(d => {
                docCounts[d.type] = (docCounts[d.type] || 0) + 1;
            });
            
            const maxDocCount = Math.max(...Object.values(docCounts), 1);
            const docLabels = {
                'passport': '–ü–∞—Å–ø–æ—Ä—Ç', 'visa': '–í–∏–∑–∞', 'insurance': '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞',
                'ticket': '–ë–∏–ª–µ—Ç', 'voucher': '–í–∞—É—á–µ—Ä'
            };
            
            let docChartHTML = '';
            for (const [type, count] of Object.entries(docCounts)) {
                const height = (count / maxDocCount) * 150;
                docChartHTML += `
                    <div class="chart-bar" style="height: ${height}px; background: var(--success);">
                        <div class="chart-bar-value">${count}</div>
                        <div class="chart-bar-label">${docLabels[type] || type}</div>
                    </div>
                `;
            }
            document.getElementById('documentsChart').innerHTML = docChartHTML;
            
            // Activity Log
            const activities = [];
            
            // Add recent document uploads
            state.documents.slice(-5).forEach(doc => {
                const pilgrim = state.pilgrims.find(p => p.id === doc.pilgrim_id);
                const user = state.users.find(u => u.id === doc.uploaded_by_user_id);
                activities.push({
                    time: doc.uploaded_at,
                    text: `${user?.name || '–ú–µ–Ω–µ–¥–∂–µ—Ä'} –∑–∞–≥—Ä—É–∑–∏–ª –¥–æ–∫—É–º–µ–Ω—Ç "${doc.type}" –¥–ª—è ${pilgrim?.full_name || '–ø–∞–ª–æ–º–Ω–∏–∫–∞'}`
                });
            });
            
            // Add recent messages
            state.message_logs.slice(-3).forEach(log => {
                const pilgrim = state.pilgrims.find(p => p.id === log.pilgrim_id);
                const template = state.message_templates.find(t => t.id === log.template_id);
                activities.push({
                    time: log.sent_at,
                    text: `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ "${template?.name || '–®–∞–±–ª–æ–Ω'}" –¥–ª—è ${pilgrim?.full_name || '–ø–∞–ª–æ–º–Ω–∏–∫–∞'}`
                });
            });
            
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            let activityHTML = '';
            activities.slice(0, 8).forEach(activity => {
                activityHTML += `
                    <div class="activity-item">
                        <div class="activity-time">${formatDateTime(activity.time)}</div>
                        <div class="activity-text">${activity.text}</div>
                    </div>
                `;
            });
            document.getElementById('activityLog').innerHTML = activityHTML || '<p style="color: var(--text-secondary);">–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>';
        }

        // Groups & Pilgrims
        function renderGroupsAndPilgrims() {
            renderGroupsList();
            renderPilgrimsList();
            if (state.selectedPilgrimId) {
                renderSelectedPilgrim();
            } else {
                document.getElementById('pilgrimDetail').innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p></div>';
            }
        }

        function renderGroupsList() {
            let html = '';
            state.service_groups.forEach(group => {
                const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                const isSelected = state.selectedGroupId === group.id;
                html += `
                    <div class="list-item ${isSelected ? 'selected' : ''}" onclick="selectGroup(${group.id})">
                        <div class="list-item-title">${group.name}</div>
                        <div class="list-item-meta">
                            ${group.route}<br>
                            ${formatDate(group.depart_date)} - ${formatDate(group.return_date)}<br>
                            <span class="status-badge status-${group.status}">${getStatusName(group.status)}</span>
                            <span style="margin-left: 8px;">üë• ${pilgrimsCount}</span>
                        </div>
                    </div>
                `;
            });
            document.getElementById('groupsList').innerHTML = html;
        }

        function selectGroup(groupId) {
            state.selectedGroupId = groupId;
            state.selectedPilgrimId = null;
            renderGroupsList();
            renderPilgrimsList();
            document.getElementById('pilgrimDetail').innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p></div>';
        }

        function renderPilgrimsList() {
            const container = document.getElementById('pilgrimsList');
            
            if (!state.selectedGroupId) {
                container.innerHTML = '<div class="placeholder"><p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É —Å–ª–µ–≤–∞</p></div>';
                return;
            }
            
            const group = state.service_groups.find(g => g.id === state.selectedGroupId);
            const pilgrims = state.pilgrims.filter(p => p.group_id === state.selectedGroupId);
            
            let html = `<div style="padding: 12px; background: var(--bg-main); margin-bottom: 12px; border-radius: 6px;">
                <strong>–ì—Ä—É–ø–ø–∞:</strong> ${group.name}<br>
                <strong>–ü–∞–ª–æ–º–Ω–∏–∫–æ–≤:</strong> ${pilgrims.length}
            </div>`;
            
            pilgrims.forEach(pilgrim => {
                const isSelected = state.selectedPilgrimId === pilgrim.id;
                const hasVisa = state.documents.some(d => d.pilgrim_id === pilgrim.id && d.type === 'visa');
                html += `
                    <div class="list-item ${isSelected ? 'selected' : ''}" onclick="selectPilgrim(${pilgrim.id})">
                        <div class="list-item-title">${pilgrim.full_name}</div>
                        <div class="list-item-meta">
                            üì± ${pilgrim.phone}<br>
                            <span class="status-badge status-${pilgrim.status}">${getStatusName(pilgrim.status)}</span>
                            ${hasVisa ? '<span style="color: var(--success); margin-left: 8px;">‚úì –í–∏–∑–∞</span>' : '<span style="color: var(--danger); margin-left: 8px;">‚úó –í–∏–∑–∞</span>'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="placeholder"><p>–ù–µ—Ç –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ –≤ –≥—Ä—É–ø–ø–µ</p></div>';
        }

        function selectPilgrim(pilgrimId) {
            state.selectedPilgrimId = pilgrimId;
            renderPilgrimsList();
            renderSelectedPilgrim();
        }

        function renderSelectedPilgrim() {
            const container = document.getElementById('pilgrimDetail');
            const pilgrim = state.pilgrims.find(p => p.id === state.selectedPilgrimId);
            
            if (!pilgrim) {
                container.innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–ü–∞–ª–æ–º–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p></div>';
                return;
            }
            
            const manager = state.users.find(u => u.id === pilgrim.manager_id);
            const group = state.service_groups.find(g => g.id === pilgrim.group_id);
            const pilgrimDocs = state.documents.filter(d => d.pilgrim_id === pilgrim.id);
            const pilgrimPayments = state.payments.filter(p => p.pilgrim_id === pilgrim.id);
            
            const visaDoc = pilgrimDocs.find(d => d.type === 'visa');
            const insuranceDoc = pilgrimDocs.find(d => d.type === 'insurance');
            
            let visaStatus = '–í–∏–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            if (visaDoc) {
                visaStatus = visaDoc.status === 'sent' ? '–í–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–∞–ª–æ–º–Ω–∏–∫—É' : '–í–∏–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
            }
            
            let insuranceStatus = insuranceDoc ? '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            
            const totalPaid = pilgrimPayments.reduce((sum, p) => sum + p.amount_usd, 0);
            const remaining = (pilgrim.tour_price_usd || 0) - totalPaid;
            
            const initials = pilgrim.full_name.split(' ').map(n => n[0]).join('');
            
            let html = `
                <div class="detail-card">
                    <div class="detail-header">
                        <div class="detail-avatar">${initials}</div>
                        <div class="detail-info">
                            <h3>${pilgrim.full_name}</h3>
                            <p>üì± ${pilgrim.phone} ‚Ä¢ WhatsApp</p>
                            <p><span class="status-badge status-${pilgrim.status}">${getStatusName(pilgrim.status)}</span></p>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div style="margin-bottom: 8px;"><strong>–ì—Ä—É–ø–ø–∞:</strong> ${group?.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'}</div>
                        <div style="margin-bottom: 8px;"><strong>–î–∞—Ç—ã:</strong> ${formatDate(pilgrim.depart_date)} - ${formatDate(pilgrim.return_date)}</div>
                        <div><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${manager?.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">–ü–∞—Å–ø–æ—Ä—Ç</div>
                        <div class="form-group">
                            <label class="form-label">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                            <input type="text" class="form-input" id="edit_passport_number" value="${pilgrim.passport_number || ''}">
                        </div>
                        <div class="detail-row">
                            <div class="form-group">
                                <label class="form-label">–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</label>
                                <input type="text" class="form-input" id="edit_passport_citizenship" value="${pilgrim.passport_citizenship || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                                <input type="date" class="form-input" id="edit_passport_birth_date" value="${pilgrim.passport_birth_date || ''}">
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="form-group">
                                <label class="form-label">–ü–æ–ª</label>
                                <select class="form-select" id="edit_passport_gender">
                                    <option value="–ú" ${pilgrim.passport_gender === '–ú' ? 'selected' : ''}>–ú—É–∂—Å–∫–æ–π</option>
                                    <option value="–ñ" ${pilgrim.passport_gender === '–ñ' ? 'selected' : ''}>–ñ–µ–Ω—Å–∫–∏–π</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                                <input type="date" class="form-input" id="edit_passport_issue_date" value="${pilgrim.passport_issue_date || ''}">
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="form-group">
                                <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" class="form-input" id="edit_passport_expiry_date" value="${pilgrim.passport_expiry_date || ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">–ö–µ–º –≤—ã–¥–∞–Ω</label>
                                <input type="text" class="form-input" id="edit_passport_authority" value="${pilgrim.passport_authority || ''}">
                            </div>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="edit_passport_verified" ${pilgrim.passport_verified ? 'checked' : ''}>
                            <label>–ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω</label>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">–í–∏–∑–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
                        <div style="margin-bottom: 12px;">
                            <strong>–°—Ç–∞—Ç—É—Å –≤–∏–∑—ã:</strong> <span style="color: ${visaDoc && visaDoc.status === 'sent' ? 'var(--success)' : 'var(--warning)'};">${visaStatus}</span><br>
                            <strong>–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏:</strong> <span style="color: ${insuranceDoc ? 'var(--success)' : 'var(--danger)'};">${insuranceStatus}</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <button class="btn btn-sm btn-primary" onclick="uploadDocument(${pilgrim.id}, 'visa')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–∑—É</button>
                            <button class="btn btn-sm btn-primary" onclick="uploadDocument(${pilgrim.id}, 'insurance')">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</button>
                            <button class="btn btn-sm btn-secondary" onclick="uploadDocument(${pilgrim.id}, 'other')">–î—Ä—É–≥–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
                        </div>
                        <table style="width: 100%; font-size: 13px;">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pilgrimDocs.map(doc => {
                                    const uploader = state.users.find(u => u.id === doc.uploaded_by_user_id);
                                    return `
                                        <tr>
                                            <td>${getDocTypeName(doc.type)}</td>
                                            <td><span class="status-badge status-${doc.status}">${getDocStatusName(doc.status)}</span></td>
                                            <td>${formatDate(doc.uploaded_at)}</td>
                                            <td>
                                                <button class="btn btn-sm btn-secondary" onclick="alert('–û—Ç–∫—Ä—ã—Ç—å: ${doc.file_url}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">–ü–ª–∞—Ç–µ–∂–∏</div>
                        <div style="margin-bottom: 12px;">
                            <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞:</strong> $${(pilgrim.tour_price_usd || 0).toLocaleString()}<br>
                            <strong>–£–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ:</strong> <span style="color: var(--success);">$${totalPaid.toLocaleString()}</span><br>
                            <strong>–û—Å—Ç–∞–ª–æ—Å—å:</strong> <span style="color: ${remaining > 0 ? 'var(--warning)' : 'var(--success)'};">$${remaining.toLocaleString()}</span>
                        </div>
                        ${state.currentRole === 'finance' ? `
                            <button class="btn btn-sm btn-primary" onclick="openAddPaymentModal(${pilgrim.id})" style="margin-bottom: 12px;">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                            </button>
                        ` : ''}
                        <table style="width: 100%; font-size: 13px;">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pilgrimPayments.map(payment => `
                                    <tr>
                                        <td>${payment.type === 'prepayment' ? '–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' : '–î–æ–ø–ª–∞—Ç–∞'}</td>
                                        <td>$${payment.amount_usd.toLocaleString()}</td>
                                        <td>${formatDate(payment.paid_at)}</td>
                                        <td>${payment.comment || '-'}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                        <div style="display: grid; gap: 12px;">
                            <div><strong>–û—Ç–µ–ª—å:</strong> ${pilgrim.hotel_name || '-'}</div>
                            <div><strong>–¢–∏–ø –æ—Ç–µ–ª—è:</strong> ${pilgrim.hotel_type || '-'}</div>
                            <div><strong>–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã:</strong> ${pilgrim.room_type || '-'}</div>
                            <div><strong>–ü–∏—Ç–∞–Ω–∏–µ:</strong> ${pilgrim.board_type || '-'}</div>
                            <div><strong>–¢—Ä–∞–Ω—Å—Ñ–µ—Ä:</strong> ${pilgrim.transfer_type || '-'}</div>
                            <div><strong>–î–∞—Ç—ã —Ç—É—Ä–∞:</strong> ${formatDate(pilgrim.tour_start_date)} - ${formatDate(pilgrim.tour_end_date)}</div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <button class="btn btn-success" onclick="savePilgrimChanges(${pilgrim.id})">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function savePilgrimChanges(pilgrimId) {
            const pilgrim = state.pilgrims.find(p => p.id === pilgrimId);
            if (!pilgrim) return;
            
            pilgrim.passport_number = document.getElementById('edit_passport_number').value;
            pilgrim.passport_citizenship = document.getElementById('edit_passport_citizenship').value;
            pilgrim.passport_birth_date = document.getElementById('edit_passport_birth_date').value;
            pilgrim.passport_gender = document.getElementById('edit_passport_gender').value;
            pilgrim.passport_issue_date = document.getElementById('edit_passport_issue_date').value;
            pilgrim.passport_expiry_date = document.getElementById('edit_passport_expiry_date').value;
            pilgrim.passport_authority = document.getElementById('edit_passport_authority').value;
            pilgrim.passport_verified = document.getElementById('edit_passport_verified').checked;
            pilgrim.updated_at = new Date().toISOString();
            
            alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)');
            renderSelectedPilgrim();
        }

        function uploadDocument(pilgrimId, docType) {
            const types = {
                'visa': '–≤–∏–∑–∞',
                'insurance': '—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞',
                'other': '–¥—Ä—É–≥–æ–π –¥–æ–∫—É–º–µ–Ω—Ç'
            };
            
            const newDoc = {
                id: state.documents.length + 1,
                pilgrim_id: pilgrimId,
                type: docType === 'other' ? 'voucher' : docType,
                file_url: `${docType}_${pilgrimId}_${Date.now()}.pdf`,
                original_name: `${types[docType]}_${Date.now()}.pdf`,
                status: 'preparing',
                uploaded_by_user_id: state.users.find(u => u.role === state.currentRole)?.id || 1,
                uploaded_at: new Date().toISOString()
            };
            
            state.documents.push(newDoc);
            alert(`–î–æ–∫—É–º–µ–Ω—Ç "${types[docType]}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è)`);
            renderSelectedPilgrim();
            renderDashboard();
        }

        // Templates
        function renderTemplatesPage() {
            const triggerTypes = {
                'time_before_departure': '–í—Ä–µ–º—è –¥–æ –≤—ã–ª–µ—Ç–∞',
                'time_before_arrival': '–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–ª—ë—Ç–∞',
                'document_based': '–ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞',
                'manual': '–í—Ä—É—á–Ω—É—é'
            };
            
            let html = '<table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞</th><th>–ö–∞–Ω–∞–ª</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            state.message_templates.forEach(template => {
                html += `
                    <tr>
                        <td>${template.name}</td>
                        <td>${triggerTypes[template.trigger_type] || template.trigger_type}</td>
                        <td>WhatsApp</td>
                        <td><span class="status-badge ${template.is_active ? 'status-sent' : 'status-new'}">${template.is_active ? '–î–∞' : '–ù–µ—Ç'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editTemplate(${template.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('templatesTable').innerHTML = html;
        }

        function editTemplate(templateId) {
            openCreateTemplateModal(templateId);
        }

        function deleteTemplate(templateId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                state.message_templates = state.message_templates.filter(t => t.id !== templateId);
                renderTemplatesPage();
            }
        }

        // Managers
        function renderManagersPage() {
            const roleNames = {
                'admin': '–ê–¥–º–∏–Ω',
                'service_manager': '–°–µ—Ä–≤–∏—Å',
                'op': '–û–ü',
                'finance': '–§–∏–Ω–∞–Ω—Å—ã'
            };
            
            let html = '<table><thead><tr><th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–†–æ–ª—å</th><th>–ü–∞–ª–æ–º–Ω–∏–∫–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            state.users.forEach(user => {
                const pilgrimsCount = state.pilgrims.filter(p => p.manager_id === user.id).length;
                const paymentsCount = state.payments.filter(p => p.created_by_user_id === user.id).length;
                
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.phone}</td>
                        <td><span class="status-badge status-ready">${roleNames[user.role] || user.role}</span></td>
                        <td>${user.role === 'service_manager' || user.role === 'op' ? pilgrimsCount : user.role === 'finance' ? paymentsCount : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editManager(${user.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteManager(${user.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('managersTable').innerHTML = html;
        }

        function editManager(userId) {
            openCreateManagerModal(userId);
        }

        function deleteManager(userId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞?')) {
                state.users = state.users.filter(u => u.id !== userId);
                renderManagersPage();
            }
        }

        // Schedule
        function renderSchedulePage() {
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            const firstDay = new Date(state.currentYear, state.currentMonth, 1);
            const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
            const startDay = firstDay.getDay() || 7; // Make Monday = 1
            
            const dayHeaders = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            let html = '';
            
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 1; i < startDay; i++) {
                html += '<div></div>';
            }
            
            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEvent = state.service_groups.some(g => 
                    g.depart_date === dateStr || g.return_date === dateStr
                );
                const isSelected = state.selectedDate === dateStr;
                
                html += `
                    <div class="calendar-day ${hasEvent ? 'has-event' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectDate('${dateStr}')">
                        ${day}
                    </div>
                `;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
            
            if (state.selectedDate) {
                renderEventsPanel();
            } else {
                document.getElementById('eventsPanel').innerHTML = '<p style="color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>';
            }
        }

        function selectDate(dateStr) {
            state.selectedDate = dateStr;
            renderCalendar();
        }

        function renderEventsPanel() {
            const events = [];
            
            // Find departures
            state.service_groups.forEach(group => {
                if (group.depart_date === state.selectedDate) {
                    events.push({
                        type: 'departure',
                        title: `–í—ã–ª–µ—Ç: ${group.name}`,
                        desc: `–ì—Ä—É–ø–ø–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ${group.route}`
                    });
                    
                    // Find templates for before departure
                    state.message_templates.filter(t => t.trigger_type === 'time_before_departure' && t.is_active).forEach(template => {
                        const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                        events.push({
                            type: 'message',
                            title: template.name,
                            desc: `–û—Ç–ø—Ä–∞–≤–∫–∞ ${pilgrimsCount} –ø–∞–ª–æ–º–Ω–∏–∫–∞–º`
                        });
                    });
                }
                
                if (group.return_date === state.selectedDate) {
                    events.push({
                        type: 'arrival',
                        title: `–ü—Ä–∏–ª—ë—Ç: ${group.name}`,
                        desc: `–ì—Ä—É–ø–ø–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è`
                    });
                    
                    state.message_templates.filter(t => t.trigger_type === 'time_before_arrival' && t.is_active).forEach(template => {
                        const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                        events.push({
                            type: 'message',
                            title: template.name,
                            desc: `–û—Ç–ø—Ä–∞–≤–∫–∞ ${pilgrimsCount} –ø–∞–ª–æ–º–Ω–∏–∫–∞–º`
                        });
                    });
                }
            });
            
            let html = '';
            if (events.length === 0) {
                html = '<p style="color: var(--text-secondary);">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</p>';
            } else {
                events.forEach(event => {
                    html += `
                        <div class="event-item">
                            <div class="event-title">${event.title}</div>
                            <div class="event-desc">${event.desc}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('eventsPanel').innerHTML = html;
        }

        function changeMonth(delta) {
            state.currentMonth += delta;
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            } else if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            state.selectedDate = null;
            renderCalendar();
        }

        // Documents
        function renderDocumentsPage() {
            const filterType = document.getElementById('filterDocType')?.value || '';
            const filterStatus = document.getElementById('filterDocStatus')?.value || '';
            
            let docs = state.documents;
            if (filterType) docs = docs.filter(d => d.type === filterType);
            if (filterStatus) docs = docs.filter(d => d.status === filterStatus);
            
            let html = '<table><thead><tr><th>–¢–∏–ø</th><th>–ü–∞–ª–æ–º–Ω–∏–∫</th><th>–ì—Ä—É–ø–ø–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–ö–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            docs.forEach(doc => {
                const pilgrim = state.pilgrims.find(p => p.id === doc.pilgrim_id);
                const group = state.service_groups.find(g => g.id === pilgrim?.group_id);
                const uploader = state.users.find(u => u.id === doc.uploaded_by_user_id);
                
                html += `
                    <tr>
                        <td>${getDocTypeName(doc.type)}</td>
                        <td>${pilgrim?.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>${group?.name || '-'}</td>
                        <td><span class="status-badge status-${doc.status}">${getDocStatusName(doc.status)}</span></td>
                        <td>${formatDate(doc.uploaded_at)}</td>
                        <td>${uploader?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="alert('–û—Ç–∫—Ä—ã—Ç—å: ${doc.file_url}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('documentsTable').innerHTML = html;
        }

        // Modals
        function openModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('genericModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('genericModal').classList.remove('show');
        }

        function openCreateGroupModal() {
            document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                    <input type="text" class="form-input" id="group_name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•–∞–¥–∂ 2025 - –ì—Ä—É–ø–ø–∞ 2">
                </div>
                <div class="form-group">
                    <label class="form-label">–ú–∞—Ä—à—Ä—É—Ç</label>
                    <input type="text" class="form-input" id="group_route" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–∫–∫–∞ - –ú–µ–¥–∏–Ω–∞">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞</label>
                        <input type="date" class="form-input" id="group_depart_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –ø—Ä–∏–ª—ë—Ç–∞</label>
                        <input type="date" class="form-input" id="group_return_date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="group_status">
                        <option value="new">–ù–æ–≤–∞—è</option>
                        <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                        <option value="flying">–õ–µ—Ç–∏—Ç</option>
                        <option value="in_trip">–í –ø–æ–µ–∑–¥–∫–µ</option>
                        <option value="finished">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const newGroup = {
                    id: state.service_groups.length + 1,
                    name: document.getElementById('group_name').value,
                    route: document.getElementById('group_route').value,
                    depart_date: document.getElementById('group_depart_date').value,
                    return_date: document.getElementById('group_return_date').value,
                    status: document.getElementById('group_status').value,
                    created_at: new Date().toISOString()
                };
                
                state.service_groups.push(newGroup);
                closeModal();
                renderGroupsAndPilgrims();
                renderDashboard();
                alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
            };
            
            openModal();
        }

        function openCreatePilgrimModal() {
            const serviceManagers = state.users.filter(u => u.role === 'service_manager');
            
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–∞–ª–æ–º–Ω–∏–∫–∞';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                    <select class="form-select" id="pilgrim_group_id">
                        ${state.service_groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–ò–û</label>
                    <input type="text" class="form-input" id="pilgrim_full_name">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-input" id="pilgrim_phone" placeholder="+77012345678">
                </div>
                <div class="form-group">
                    <label class="form-label">–°–µ—Ä–≤–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä</label>
                    <select class="form-select" id="pilgrim_manager_id">
                        ${serviceManagers.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–û—Ç–µ–ª—å</label>
                        <input type="text" class="form-input" id="pilgrim_hotel_name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –æ—Ç–µ–ª—è</label>
                        <select class="form-select" id="pilgrim_hotel_type">
                            <option>3 –∑–≤–µ–∑–¥—ã</option>
                            <option>4 –∑–≤–µ–∑–¥—ã</option>
                            <option>5 –∑–≤–µ–∑–¥</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã</label>
                        <select class="form-select" id="pilgrim_room_type">
                            <option>–û–¥–Ω–æ–º–µ—Å—Ç–Ω—ã–π</option>
                            <option>–î–≤—É—Ö–º–µ—Å—Ç–Ω—ã–π</option>
                            <option>–¢—Ä—ë—Ö–º–µ—Å—Ç–Ω—ã–π</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü–∏—Ç–∞–Ω–∏–µ</label>
                        <select class="form-select" id="pilgrim_board_type">
                            <option>–ë–µ–∑ –ø–∏—Ç–∞–Ω–∏—è</option>
                            <option>–ó–∞–≤—Ç—Ä–∞–∫</option>
                            <option>–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω</option>
                            <option>–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞</label>
                    <select class="form-select" id="pilgrim_transfer_type">
                        <option>–ì—Ä—É–ø–ø–æ–≤–æ–π</option>
                        <option>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π</option>
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—É—Ä–∞</label>
                        <input type="date" class="form-input" id="pilgrim_tour_start_date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—É—Ä–∞</label>
                        <input type="date" class="form-input" id="pilgrim_tour_end_date">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ (USD)</label>
                    <input type="number" class="form-input" id="pilgrim_tour_price_usd">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (USD)</label>
                    <input type="number" class="form-input" id="pilgrim_prepayment">
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const groupId = parseInt(document.getElementById('pilgrim_group_id').value);
                const group = state.service_groups.find(g => g.id === groupId);
                
                const newPilgrim = {
                    id: state.pilgrims.length + 1,
                    group_id: groupId,
                    manager_id: parseInt(document.getElementById('pilgrim_manager_id').value),
                    full_name: document.getElementById('pilgrim_full_name').value,
                    phone: document.getElementById('pilgrim_phone').value,
                    messenger: 'whatsapp',
                    status: 'new',
                    depart_date: group?.depart_date || '',
                    return_date: group?.return_date || '',
                    hotel_name: document.getElementById('pilgrim_hotel_name').value,
                    hotel_type: document.getElementById('pilgrim_hotel_type').value,
                    room_type: document.getElementById('pilgrim_room_type').value,
                    board_type: document.getElementById('pilgrim_board_type').value,
                    transfer_type: document.getElementById('pilgrim_transfer_type').value,
                    tour_start_date: document.getElementById('pilgrim_tour_start_date').value,
                    tour_end_date: document.getElementById('pilgrim_tour_end_date').value,
                    tour_price_usd: parseFloat(document.getElementById('pilgrim_tour_price_usd').value) || 0,
                    passport_number: '',
                    passport_citizenship: '',
                    passport_birth_date: '',
                    passport_gender: '–ú',
                    passport_issue_date: '',
                    passport_expiry_date: '',
                    passport_authority: '',
                    passport_photo_url: '',
                    passport_verified: false,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                state.pilgrims.push(newPilgrim);
                
                const prepayment = parseFloat(document.getElementById('pilgrim_prepayment').value) || 0;
                if (prepayment > 0) {
                    state.payments.push({
                        id: state.payments.length + 1,
                        pilgrim_id: newPilgrim.id,
                        type: 'prepayment',
                        amount_usd: prepayment,
                        paid_at: new Date().toISOString().split('T')[0],
                        created_by_user_id: state.users.find(u => u.role === state.currentRole)?.id || 1,
                        comment: '–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'
                    });
                }
                
                closeModal();
                renderGroupsAndPilgrims();
                renderDashboard();
                alert('–ü–∞–ª–æ–º–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function openCreateTemplateModal(templateId = null) {
            const template = templateId ? state.message_templates.find(t => t.id === templateId) : null;
            const isEdit = !!template;
            
            document.getElementById('modalTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω' : '–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="template_name" value="${template?.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞</label>
                    <select class="form-select" id="template_trigger_type" onchange="updateTriggerFields()">
                        <option value="time_before_departure" ${template?.trigger_type === 'time_before_departure' ? 'selected' : ''}>–í—Ä–µ–º—è –¥–æ –≤—ã–ª–µ—Ç–∞</option>
                        <option value="time_before_arrival" ${template?.trigger_type === 'time_before_arrival' ? 'selected' : ''}>–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–ª—ë—Ç–∞</option>
                        <option value="document_based" ${template?.trigger_type === 'document_based' ? 'selected' : ''}>–ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</option>
                        <option value="manual" ${template?.trigger_type === 'manual' ? 'selected' : ''}>–í—Ä—É—á–Ω—É—é</option>
                    </select>
                </div>
                <div id="trigger_fields">
                    ${getTriggerFields(template)}
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                    <textarea class="form-textarea" id="template_body" placeholder="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {name}, {depart_date}, {hotel_name}, {manager_name}">${template?.body || ''}</textarea>
                    <small style="color: var(--text-secondary);">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {name}, {depart_date}, {return_date}, {hotel_name}, {manager_name}</small>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="template_can_attach_file" ${template?.can_attach_file ? 'checked' : ''}>
                    <label>–ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="template_is_active" ${template?.is_active !== false ? 'checked' : ''}>
                    <label>–ê–∫—Ç–∏–≤–µ–Ω</label>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const triggerType = document.getElementById('template_trigger_type').value;
                
                const newTemplate = {
                    id: template?.id || state.message_templates.length + 1,
                    name: document.getElementById('template_name').value,
                    trigger_type: triggerType,
                    trigger_key: triggerType.replace('time_', '').replace('_based', ''),
                    offset_days: parseInt(document.getElementById('template_offset_days')?.value) || 0,
                    offset_hours: parseInt(document.getElementById('template_offset_hours')?.value) || 0,
                    offset_minutes: parseInt(document.getElementById('template_offset_minutes')?.value) || 0,
                    document_type: document.getElementById('template_document_type')?.value || null,
                    channel: 'whatsapp',
                    body: document.getElementById('template_body').value,
                    variables: {},
                    can_attach_file: document.getElementById('template_can_attach_file').checked,
                    is_active: document.getElementById('template_is_active').checked,
                    created_at: template?.created_at || new Date().toISOString()
                };
                
                if (isEdit) {
                    const index = state.message_templates.findIndex(t => t.id === template.id);
                    state.message_templates[index] = newTemplate;
                } else {
                    state.message_templates.push(newTemplate);
                }
                
                closeModal();
                renderTemplatesPage();
                alert(isEdit ? '–®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω' : '–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω');
            };
            
            openModal();
        }

        function getTriggerFields(template) {
            const triggerType = template?.trigger_type || 'time_before_departure';
            
            if (triggerType.startsWith('time_')) {
                return `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–î–Ω–µ–π</label>
                            <input type="number" class="form-input" id="template_offset_days" value="${template?.offset_days || -7}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ß–∞—Å–æ–≤</label>
                            <input type="number" class="form-input" id="template_offset_hours" value="${template?.offset_hours || 0}">
                        </div>
                    </div>
                    <small style="color: var(--text-secondary);">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –¥–æ —Å–æ–±—ã—Ç–∏—è</small>
                `;
            } else if (triggerType === 'document_based') {
                return `
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                        <select class="form-select" id="template_document_type">
                            <option value="visa" ${template?.document_type === 'visa' ? 'selected' : ''}>–í–∏–∑–∞</option>
                            <option value="insurance" ${template?.document_type === 'insurance' ? 'selected' : ''}>–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                            <option value="ticket" ${template?.document_type === 'ticket' ? 'selected' : ''}>–ë–∏–ª–µ—Ç</option>
                            <option value="voucher" ${template?.document_type === 'voucher' ? 'selected' : ''}>–í–∞—É—á–µ—Ä</option>
                        </select>
                    </div>
                `;
            }
            
            return '<p style="color: var(--text-secondary);">–†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è</p>';
        }

        function updateTriggerFields() {
            const triggerType = document.getElementById('template_trigger_type').value;
            document.getElementById('trigger_fields').innerHTML = getTriggerFields({ trigger_type: triggerType });
        }

        function openCreateManagerModal(userId = null) {
            const user = userId ? state.users.find(u => u.id === userId) : null;
            const isEdit = !!user;
            
            document.getElementById('modalTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞' : '–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è</label>
                    <input type="text" class="form-input" id="manager_name" value="${user?.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-input" id="manager_phone" value="${user?.phone || ''}" placeholder="+77012345678">
                </div>
                <div class="form-group">
                    <label class="form-label">–†–æ–ª—å</label>
                    <select class="form-select" id="manager_role">
                        <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω</option>
                        <option value="service_manager" ${user?.role === 'service_manager' ? 'selected' : ''}>–°–µ—Ä–≤–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä</option>
                        <option value="op" ${user?.role === 'op' ? 'selected' : ''}>–û–ü</option>
                        <option value="finance" ${user?.role === 'finance' ? 'selected' : ''}>–§–∏–Ω–∞–Ω—Å—ã</option>
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const newUser = {
                    id: user?.id || state.users.length + 1,
                    name: document.getElementById('manager_name').value,
                    phone: document.getElementById('manager_phone').value,
                    role: document.getElementById('manager_role').value,
                    created_at: user?.created_at || new Date().toISOString()
                };
                
                if (isEdit) {
                    const index = state.users.findIndex(u => u.id === user.id);
                    state.users[index] = newUser;
                } else {
                    state.users.push(newUser);
                }
                
                closeModal();
                renderManagersPage();
                alert(isEdit ? '–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function openAddPaymentModal(pilgrimId) {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞</label>
                    <select class="form-select" id="payment_type">
                        <option value="prepayment">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                        <option value="extra">–î–æ–ø–ª–∞—Ç–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞ (USD)</label>
                    <input type="number" class="form-input" id="payment_amount">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea class="form-textarea" id="payment_comment"></textarea>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const newPayment = {
                    id: state.payments.length + 1,
                    pilgrim_id: pilgrimId,
                    type: document.getElementById('payment_type').value,
                    amount_usd: parseFloat(document.getElementById('payment_amount').value) || 0,
                    paid_at: new Date().toISOString().split('T')[0],
                    created_by_user_id: state.users.find(u => u.role === 'finance')?.id || 1,
                    comment: document.getElementById('payment_comment').value
                };
                
                state.payments.push(newPayment);
                closeModal();
                renderSelectedPilgrim();
                renderDashboard();
                alert('–ü–ª–∞—Ç–µ–∂ –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function openUploadDocumentModal() {
            document.getElementById('modalTitle').textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ü–∞–ª–æ–º–Ω–∏–∫</label>
                    <select class="form-select" id="doc_pilgrim_id">
                        ${state.pilgrims.map(p => `<option value="${p.id}">${p.full_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <select class="form-select" id="doc_type">
                        <option value="passport">–ü–∞—Å–ø–æ—Ä—Ç</option>
                        <option value="visa">–í–∏–∑–∞</option>
                        <option value="insurance">–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                        <option value="ticket">–ë–∏–ª–µ—Ç</option>
                        <option value="voucher">–í–∞—É—á–µ—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="doc_status">
                        <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                        <option value="ready_to_send">–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                        <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const type = document.getElementById('doc_type').value;
                const pilgrimId = parseInt(document.getElementById('doc_pilgrim_id').value);
                
                const newDoc = {
                    id: state.documents.length + 1,
                    pilgrim_id: pilgrimId,
                    type: type,
                    file_url: `${type}_${pilgrimId}_${Date.now()}.pdf`,
                    original_name: `${type}_${Date.now()}.pdf`,
                    status: document.getElementById('doc_status').value,
                    uploaded_by_user_id: state.users.find(u => u.role === state.currentRole)?.id || 1,
                    uploaded_at: new Date().toISOString()
                };
                
                state.documents.push(newDoc);
                closeModal();
                renderDocumentsPage();
                renderDashboard();
                alert('–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            };
            
            openModal();
        }

        // Settings
        function testMessengerConnection() {
            alert('–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–∏–º—É–ª—è—Ü–∏—è).\n\n–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ WhatsApp!');
        }

        function saveSettings() {
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)');
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        function getStatusName(status) {
            const names = {
                'new': '–ù–æ–≤—ã–π',
                'preparing': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
                'ready': '–ì–æ—Ç–æ–≤',
                'flying': '–õ–µ—Ç–∏—Ç',
                'in_trip': '–í –ø–æ–µ–∑–¥–∫–µ',
                'in_hotel': '–í –æ—Ç–µ–ª–µ',
                'rituals': '–û–±—Ä—è–¥—ã',
                'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                'training': '–û–±—É—á–µ–Ω–∏–µ'
            };
            return names[status] || status;
        }

        function getDocTypeName(type) {
            const names = {
                'passport': '–ü–∞—Å–ø–æ—Ä—Ç',
                'visa': '–í–∏–∑–∞',
                'insurance': '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞',
                'ticket': '–ë–∏–ª–µ—Ç',
                'voucher': '–í–∞—É—á–µ—Ä',
                'hotel_voucher': '–í–∞—É—á–µ—Ä –æ—Ç–µ–ª—è',
                'itinerary': '–ú–∞—Ä—à—Ä—É—Ç',
                'memo': '–ü–∞–º—è—Ç–∫–∞'
            };
            return names[type] || type;
        }

        function getDocStatusName(status) {
            const names = {
                'preparing': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
                'ready_to_send': '–ì–æ—Ç–æ–≤–æ',
                'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'
            };
            return names[status] || status;
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initUI);
    </script>
</body>
</html>