<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Travel ‚Äî Service & Visa Hub</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --sidebar-bg: #1e293b;
            --sidebar-hover: #334155;
            --sidebar-active: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            font-size: 18px;
            font-weight: 600;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-item:hover {
            background: var(--sidebar-hover);
        }

        .sidebar-item.active {
            background: var(--sidebar-active);
            border-left: 3px solid white;
        }

        .sidebar-icon {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
        }

        .role-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-badge {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            position: relative;
        }

        .role-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 150px;
        }

        .role-dropdown.show {
            display: block;
        }

        .role-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .role-option:hover {
            background: var(--bg-main);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .metric-sublabel {
            color: var(--text-secondary);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-main);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: var(--bg-main);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-main);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
        }

        /* Three Column Layout */
        .three-column-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .column {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-main);
        }

        .column-title {
            font-weight: 600;
            font-size: 16px;
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* List Items */
        .list-item {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: var(--primary);
            background: var(--bg-main);
        }

        .list-item.selected {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .list-item-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-new { background: #dbeafe; color: #1e40af; }
        .status-preparing { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-flying { background: #e0e7ff; color: #3730a3; }
        .status-sent { background: #dcfce7; color: #166534; }
        .status-viza-bar { background: #f3e8ff; color: #7c3aed; }

        /* Detail Card */
        .detail-card {
            padding: 0;
        }

        .detail-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .detail-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
        }

        .detail-info h3 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .detail-info p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .detail-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .detail-section-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Chart */
        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px;
        }

        .chart-bar {
            flex: 1;
            background: var(--primary);
            border-radius: 4px 4px 0 0;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
        }

        .chart-bar-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        .chart-bar-value {
            font-size: 12px;
            font-weight: 600;
            color: white;
            padding: 4px;
        }

        /* Activity Log */
        .activity-item {
            padding: 12px;
            border-left: 3px solid var(--primary);
            background: var(--bg-main);
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .activity-text {
            font-size: 14px;
        }

        /* Calendar */
        .calendar-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .calendar {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-month {
            font-size: 18px;
            font-weight: 600;
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-main);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
        }

        .calendar-day.selected.has-event::after {
            background: white;
        }

        .events-panel {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
        }

        .event-item {
            padding: 12px;
            background: var(--bg-main);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .event-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .event-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
        }

        .filter-group {
            flex: 1;
            min-width: 180px;
        }

        /* Dashboard Toggle */
        .dashboard-toggle {
            display: flex;
            background: var(--bg-main);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px 16px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .toggle-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Kanban */
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            height: 600px;
        }

        .kanban-column {
            background: var(--bg-main);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .kanban-header {
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .kanban-card {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: move;
        }

        .kanban-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .kanban-card-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kanban-card-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .doc-status {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            font-size: 11px;
        }

        .doc-status-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        /* Currency Input */
        .currency-input-group {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 12px;
            align-items: end;
        }

        .currency-separator {
            text-align: center;
            padding-bottom: 10px;
            color: var(--text-secondary);
        }

        /* Warning */
        .warning {
            color: var(--warning);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        .warning.show {
            display: block;
        }

        /* Roommates & Booking Badges */
        .room-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .booking-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #fef3c7;
            color: #92400e;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .family-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #f0f9ff;
            color: #0369a1;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }

        .roommates-list {
            margin-top: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .roommate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .roommate-item:last-child {
            border-bottom: none;
        }

        .booking-group {
            margin-top: 12px;
            padding: 12px;
            background: #fef3c7;
            border-radius: 6px;
            border: 1px solid #fbbf24;
        }

        .booking-room {
            margin-top: 8px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 4px;
        }

        .family-block {
            margin-top: 12px;
            padding: 12px;
            background: #f0f9ff;
            border-radius: 6px;
            border: 1px solid #7dd3fc;
        }

        /* Child/Infant badges */
        .child-badge {
            background: #dcfce7;
            color: #166534;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 4px;
        }

        .infant-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            margin-left: 4px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .three-column-layout {
                grid-template-columns: 1fr;
            }
            
            .column {
                height: auto;
            }
            
            .kanban-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .currency-input-group {
                grid-template-columns: 1fr;
            }
            
            .kanban-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Atlas Travel</div>
                <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Service & Visa Hub</div>
            </div>
            <nav class="sidebar-menu">
                <div class="sidebar-item active" onclick="showPage('dashboard')">
                    <span class="sidebar-icon">üìä</span>
                    <span>–î–∞—à–±–æ—Ä–¥</span>
                </div>
                <div class="sidebar-item" onclick="showPage('groups')">
                    <span class="sidebar-icon">üë•</span>
                    <span>–ì—Ä—É–ø–ø—ã –∏ –ø–∞–ª–æ–º–Ω–∏–∫–∏</span>
                </div>
                <div class="sidebar-item" onclick="showPage('templates')">
                    <span class="sidebar-icon">üí¨</span>
                    <span>–®–∞–±–ª–æ–Ω—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('managers')">
                    <span class="sidebar-icon">üë§</span>
                    <span>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('schedule')">
                    <span class="sidebar-icon">üìÖ</span>
                    <span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                </div>
                <div class="sidebar-item" onclick="showPage('documents')">
                    <span class="sidebar-icon">üìÑ</span>
                    <span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                </div>
                <div class="sidebar-item" onclick="showPage('settings')">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-title">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º</div>
                <div class="role-switcher">
                    <div class="role-badge" onclick="toggleRoleDropdown()">
                        –†–æ–ª—å: <span id="currentRole">–ê–¥–º–∏–Ω</span> ‚ñº
                        <div class="role-dropdown" id="roleDropdown">
                            <div class="role-option" onclick="switchRole('admin', '–ê–¥–º–∏–Ω')">–ê–¥–º–∏–Ω</div>
                            <div class="role-option" onclick="switchRole('service_manager', '–°–µ—Ä–≤–∏—Å')">–°–µ—Ä–≤–∏—Å</div>
                            <div class="role-option" onclick="switchRole('op', '–û–ü')">–û–ü</div>
                            <div class="role-option" onclick="switchRole('finance', '–§–∏–Ω–∞–Ω—Å—ã')">–§–∏–Ω–∞–Ω—Å—ã</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Page -->
                <section id="page-dashboard" class="page-section active">
                    <h2 style="margin-bottom: 16px;">–î–∞—à–±–æ—Ä–¥</h2>
                    
                    <!-- Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <label class="form-label">–ú–µ—Å—è—Ü</label>
                            <select class="form-select" id="filterMonth" onchange="updateDashboard()">
                                <option value="">–í—Å–µ</option>
                                <option value="current">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                                <option value="next">–°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü</option>
                                <option value="2025-01">–Ø–Ω–≤–∞—Ä—å 2025</option>
                                <option value="2025-02">–§–µ–≤—Ä–∞–ª—å 2025</option>
                                <option value="2025-06">–ò—é–Ω—å 2025</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞</label>
                            <select class="form-select" id="filterCity" onchange="updateDashboard()">
                                <option value="">–í—Å–µ</option>
                                <option value="ALA">–ê–ª–º–∞—Ç—ã (ALA)</option>
                                <option value="NQZ">–ù—É—Ä-–°—É–ª—Ç–∞–Ω (NQZ)</option>
                                <option value="CIT">–®—ã–º–∫–µ–Ω—Ç (CIT)</option>
                                <option value="GUW">–ê—Ç—ã—Ä–∞—É (GUW)</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">–ì—Ä—É–ø–ø–∞</label>
                            <select class="form-select" id="filterGroup" onchange="updateDashboard()">
                                <option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                            <select class="form-select" id="filterManager" onchange="updateDashboard()">
                                <option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å –ø–∞–ª–æ–º–Ω–∏–∫–∞</label>
                            <select class="form-select" id="filterPilgrimStatus" onchange="updateDashboard()">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="new">–ù–æ–≤—ã–π</option>
                                <option value="training">–û–±—É—á–µ–Ω–∏–µ</option>
                                <option value="ready">–ì–æ—Ç–æ–≤</option>
                                <option value="flying">–õ–µ—Ç–∏—Ç</option>
                                <option value="in_hotel">–í –æ—Ç–µ–ª–µ</option>
                                <option value="rituals">–û–±—Ä—è–¥—ã</option>
                                <option value="finished">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                            </select>
                        </div>
                    </div>

                    <!-- Dashboard Toggle -->
                    <div class="dashboard-toggle">
                        <div class="toggle-btn active" onclick="switchDashboardMode('kanban')" id="toggleKanban">
                            üìã –ö–∞–Ω–±–∞–Ω –ø–æ –≥—Ä—É–ø–ø–∞–º
                        </div>
                        <div class="toggle-btn" onclick="switchDashboardMode('table')" id="toggleTable">
                            üìä –¢–∞–±–ª–∏—Ü–∞ –ø–æ –ø–∞–ª–æ–º–Ω–∏–∫–∞–º
                        </div>
                    </div>

                    <!-- Metrics -->
                    <div class="metrics-grid" id="metricsGrid"></div>

                    <!-- Dashboard Content -->
                    <div id="dashboardKanban" style="display: block;">
                        <div class="kanban-container" id="kanbanContainer"></div>
                    </div>
                    
                    <div id="dashboardTable" style="display: none;">
                        <div class="card">
                            <div class="filters" style="margin-bottom: 0; padding: 12px;">
                                <div class="filter-group">
                                    <label class="form-label">–ü–æ–∏—Å–∫</label>
                                    <input type="text" class="form-input" id="tableSearch" placeholder="–ò–º—è –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω" oninput="updatePilgrimTable()">
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">–í–∏–∑–∞</label>
                                    <select class="form-select" id="tableVisaFilter" onchange="updatePilgrimTable()">
                                        <option value="">–í—Å–µ</option>
                                        <option value="not_required">–ù–µ –Ω—É–∂–Ω–∞</option>
                                        <option value="no">–ù–µ—Ç</option>
                                        <option value="uploaded">–ó–∞–≥—Ä—É–∂–µ–Ω–∞</option>
                                        <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">–û–ø–ª–∞—Ç–∞</label>
                                    <select class="form-select" id="tablePaymentFilter" onchange="updatePilgrimTable()">
                                        <option value="">–í—Å–µ</option>
                                        <option value="pending">–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å > 0</option>
                                        <option value="paid">–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å = 0</option>
                                    </select>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="pilgrimsTable">
                                    <thead>
                                        <tr>
                                            <th>–ü–∞–ª–æ–º–Ω–∏–∫</th>
                                            <th>–ì—Ä—É–ø–ø–∞</th>
                                            <th>–ö–æ–º–Ω–∞—Ç–∞</th>
                                            <th>–ó–∞—è–≤–∫–∞</th>
                                            <th>–†–æ–¥–∏—Ç–µ–ª—å/–î–µ—Ç–∏</th>
                                            <th>–ú–∞—Ä—à—Ä—É—Ç</th>
                                            <th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th>
                                            <th>–°—Ç–∞—Ç—É—Å</th>
                                            <th>–ì–æ—Ä–æ–¥ –≤—ã–ª–µ—Ç–∞</th>
                                            <th>–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞</th>
                                            <th>–î–∞—Ç–∞ –ø—Ä–∏–ª—ë—Ç–∞</th>
                                            <th>–í–∏–∑–∞</th>
                                            <th>–û–ø–ª–∞—á–µ–Ω–æ / –û—Å—Ç–∞–ª–æ—Å—å</th>
                                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</th>
                                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pilgrimsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Groups & Pilgrims Page -->
                <section id="page-groups" class="page-section">
                    <h2 style="margin-bottom: 24px;">–ì—Ä—É–ø–ø—ã –∏ –ø–∞–ª–æ–º–Ω–∏–∫–∏</h2>
                    <div class="three-column-layout">
                        <!-- Groups Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title">–ì—Ä—É–ø–ø—ã</div>
                                <button class="btn btn-primary btn-sm" onclick="openCreateGroupModal()">‚ûï</button>
                            </div>
                            <div class="column-content" id="groupsList"></div>
                        </div>

                        <!-- Pilgrims Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title" id="pilgrimsColumnTitle">–ü–∞–ª–æ–º–Ω–∏–∫–∏</div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary btn-sm" onclick="openCreatePilgrimModal()">‚ûï</button>
                                    <button class="btn btn-secondary btn-sm" onclick="toggleShowAll()" id="showAllBtn">
                                        –í—Å–µ
                                    </button>
                                </div>
                            </div>
                            <div class="column-content" id="pilgrimsList"></div>
                        </div>

                        <!-- Pilgrim Detail Column -->
                        <div class="column">
                            <div class="column-header">
                                <div class="column-title">–î–µ—Ç–∞–ª–∏ –ø–∞–ª–æ–º–Ω–∏–∫–∞</div>
                            </div>
                            <div class="column-content" id="pilgrimDetail"></div>
                        </div>
                    </div>
                </section>

                <!-- Templates Page -->
                <section id="page-templates" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                            <button class="btn btn-primary btn-sm" onclick="openCreateTemplateModal()">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
                            </button>
                        </div>
                        <div class="table-container" id="templatesTable"></div>
                    </div>
                </section>

                <!-- Managers Page -->
                <section id="page-managers" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</span>
                            <button class="btn btn-primary btn-sm" onclick="openCreateManagerModal()">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                            </button>
                        </div>
                        <div class="table-container" id="managersTable"></div>
                    </div>
                </section>

                <!-- Schedule Page -->
                <section id="page-schedule" class="page-section">
                    <h2 style="margin-bottom: 24px;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤</h2>
                    <div class="calendar-container">
                        <div class="calendar">
                            <div class="calendar-header">
                                <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">‚óÄ</button>
                                <div class="calendar-month" id="calendarMonth"></div>
                                <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)">‚ñ∂</button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                        <div class="events-panel">
                            <h3 style="margin-bottom: 16px;">–°–æ–±—ã—Ç–∏—è –¥–Ω—è</h3>
                            <div id="eventsPanel"></div>
                        </div>
                    </div>
                </section>

                <!-- Documents Page -->
                <section id="page-documents" class="page-section">
                    <div class="card">
                        <div class="card-header">
                            <span>–î–æ–∫—É–º–µ–Ω—Ç—ã</span>
                            <button class="btn btn-primary btn-sm" onclick="openUploadDocumentModal()">
                                ‚ûï –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                            </button>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <select class="form-select" id="filterDocType" onchange="renderDocumentsPage()">
                                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                    <option value="passport">–ü–∞—Å–ø–æ—Ä—Ç</option>
                                    <option value="visa">–í–∏–∑–∞</option>
                                    <option value="insurance">–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                                    <option value="ticket">–ë–∏–ª–µ—Ç</option>
                                    <option value="voucher">–í–∞—É—á–µ—Ä</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="filterDocStatus" onchange="renderDocumentsPage()">
                                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                    <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                                    <option value="ready_to_send">–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                                    <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container" id="documentsTable"></div>
                    </div>
                </section>

                <!-- Settings Page -->
                <section id="page-settings" class="page-section">
                    <h2 style="margin-bottom: 24px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                    
                    <div class="card">
                        <div class="card-header">–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</div>
                        <div class="form-group">
                            <label class="form-label">–û—Ç–µ–ª–∏</label>
                            <textarea class="form-textarea" id="settingsHotels" placeholder="–ö–∞–∂–¥—ã–π –æ—Ç–µ–ª—å —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</label>
                            <input type="text" class="form-input" id="settingsAccommodation" value="DB, TRP, QAUD">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø—ã —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞</label>
                            <input type="text" class="form-input" id="settingsTransfer" value="TRAIN, BUS, 2TRAINS, BUSINESS TRAIN">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–∞–∑–º–µ—Ä—ã –æ–¥–µ–∂–¥—ã (NABOR)</label>
                            <input type="text" class="form-input" id="settingsNabor" value="S, M, L, XL, 2XL, 3XL, 4XL, 5XL, NO">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–µ—Ç–∏/–ò–Ω—Ñ–∞–Ω—Ç—ã</label>
                            <input type="text" class="form-input" id="settingsChildTypes" value="CHILD (2-11), INFANT (0-23 –º–µ—Å—è—Ü–µ–≤)">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã</div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp API –∫–ª—é—á</label>
                            <input type="text" class="form-input" id="settingWhatsappKey" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp Endpoint</label>
                            <input type="text" class="form-input" id="settingWhatsappEndpoint" placeholder="https://api.whatsapp.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Telegram Bot Token</label>
                            <input type="text" class="form-input" id="settingTelegramToken" placeholder="–î–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è">
                        </div>
                        <button class="btn btn-primary" onclick="testMessengerConnection()">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
                        <div class="form-group">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è</label>
                            <input type="number" class="form-input" id="settingMinPasswordLength" value="8">
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="settingRequireSpecialChars" checked>
                            <label>–¢—Ä–µ–±–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –ø–∞—Ä–æ–ª–µ</label>
                        </div>
                    </div>

                    <button class="btn btn-success" onclick="saveSettings()">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()"></div>

    <!-- Generic Modal -->
    <div class="modal" id="genericModal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="modalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- Roommate Modal -->
    <div class="modal" id="roommateModal">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å–µ–¥–∞ –≤ –Ω–æ–º–µ—Ä</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="roommateModalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="roommateModalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- Linked Booking Modal -->
    <div class="modal" id="linkedBookingModal">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞—è–≤–∫—É</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="linkedBookingModalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="linkedBookingModalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- Child/Infant Modal -->
    <div class="modal" id="childModal">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="childModalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="childModalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- Add Relations Modal -->
    <div class="modal" id="addRelationsModal">
        <div class="modal-header">
            <h3 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–∞–ª–æ–º–Ω–∏–∫–∞</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="addRelationsModalBody"></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="addRelationsModalSaveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // Global State
        let state = {
            currentRole: 'admin',
            currentRoleName: '–ê–¥–º–∏–Ω',
            selectedGroupId: null,
            selectedPilgrimId: null,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDate: null,
            dashboardMode: 'kanban',
            showAllPilgrims: false,
            users: [],
            service_groups: [],
            pilgrims: [],
            documents: [],
            payments: [],
            message_templates: [],
            message_logs: [],
            currentRoommateLeaderId: null,
            currentBookingLeaderId: null,
            currentParentId: null,
            settings: {
                hotels: ['Hilton Makkah', 'Swissotel Makkah', 'Pullman Zamzam', 'Movenpick Hotel', 'InterContinental'],
                accommodation_types: ['DB', 'TRP', 'QAUD'],
                transfer_types: ['TRAIN', 'BUS', '2TRAINS', 'BUSINESS TRAIN'],
                nabor_sizes: ['S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5XL', 'NO'],
                child_types: ['CHILD (2-11)', 'INFANT (0-23 –º–µ—Å—è—Ü–µ–≤)']
            }
        };

        // Initialize Data
        function initData() {
            // Users
            state.users = [
                { id: 1, name: '–ù—É—Ä–ª–∞–Ω –ê–±–¥—É–ª–ª–∞–µ–≤', phone: '+77012345678', role: 'admin', created_at: '2024-01-15' },
                { id: 2, name: '–ê–π–≥—É–ª—å –°–∞–ø–∞—Ä–æ–≤–∞', phone: '+77012345679', role: 'service_manager', created_at: '2024-01-16' },
                { id: 3, name: '–ê–π—à–∞ –ö–∞—Å—ã–º–æ–≤–∞', phone: '+77012345680', role: 'op', created_at: '2024-01-17' },
                { id: 4, name: '–î–∞–º–∏—Ä –ò–±—Ä–∞–µ–≤', phone: '+77012345681', role: 'finance', created_at: '2024-01-18' },
                { id: 5, name: '–ì—É–ª—å–Ω–∞—Ä–∞ –û—Ä–∞–∑–æ–≤–∞', phone: '+77012345682', role: 'service_manager', created_at: '2024-02-01' }
            ];

            // Service Groups - Updated with new fields
            state.service_groups = [
                { 
                    id: 1, 
                    name: '01.11 - 08.11   ALA-JED   MED-ALA   AIR ASTANA', 
                    depart_date: '2025-06-10', 
                    return_date: '2025-06-25', 
                    depart_route: 'ALA-JED',
                    return_route: 'MED-ALA',
                    airline: 'AIR ASTANA',
                    status: 'preparing', 
                    created_at: '2024-11-01',
                    allowed_hotels: ['Hilton Makkah', 'Swissotel Makkah']
                },
                { 
                    id: 2, 
                    name: '15.01 - 22.01   ALA-JED   JED-ALA   SCAT', 
                    depart_date: '2025-01-15', 
                    return_date: '2025-01-22', 
                    depart_route: 'ALA-JED',
                    return_route: 'JED-ALA',
                    airline: 'SCAT',
                    status: 'flying', 
                    created_at: '2024-11-15',
                    allowed_hotels: ['Pullman Zamzam', 'Movenpick Hotel']
                },
                { 
                    id: 3, 
                    name: '20.12 - 27.12   NQZ-MED   MED-NQZ   AIR ASTANA', 
                    depart_date: '2024-12-20', 
                    return_date: '2024-12-27', 
                    depart_route: 'NQZ-MED',
                    return_route: 'MED-NQZ',
                    airline: 'AIR ASTANA',
                    status: 'new', 
                    created_at: '2024-11-20',
                    allowed_hotels: []
                }
            ];

            // Pilgrims - Updated with new fields for roommates, linked bookings, and children
            state.pilgrims = [
                {
                    id: 1, group_id: 1, manager_id: 2,
                    latin_first_name: 'Asylkhan', latin_last_name: 'Nurbekov',
                    phone: '+77011111111', iin: '123456789012', messenger: 'whatsapp', status: 'ready',
                    visa_required: 'YES', nabor_size: 'L', comment: '',
                    hotel_name: 'Hilton Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'DB', board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: 'BUS', tour_price_usd: 5500,
                    passport_number: 'N12345678', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '1980-05-15',
                    passport_gender: '–ú', passport_issue_date: '2020-03-10', 
                    passport_expiry_date: '2030-03-10',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: true,
                    room_lead_id: null, // –õ–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
                    booking_lead_id: null, // –õ–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏
                    parent_id: null, // –ù–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
                    depart_date: '2025-06-10',
                    return_date: '2025-06-25',
                    created_at: '2024-11-05', updated_at: '2024-12-01'
                },
                {
                    id: 2, group_id: 1, manager_id: 2,
                    latin_first_name: 'Nurbek', latin_last_name: 'Asylkhanov',
                    phone: '+77011111119', iin: '123456789013', messenger: 'whatsapp', status: 'ready',
                    visa_required: 'YES', nabor_size: 'M', comment: '–ë—Ä–∞—Ç –ê—Å—ã–ª—Ö–∞–Ω–∞',
                    hotel_name: 'Hilton Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'DB', board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: 'BUS', tour_price_usd: 5500,
                    passport_number: 'N12345679', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '1982-08-20',
                    passport_gender: '–ú', passport_issue_date: '2020-04-15', 
                    passport_expiry_date: '2030-04-15',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: true,
                    room_lead_id: 1, // –°–æ—Å–µ–¥ –ê—Å—ã–ª—Ö–∞–Ω–∞
                    booking_lead_id: 1, // –í —Ç–æ–π –∂–µ –∑–∞—è–≤–∫–µ
                    parent_id: null,
                    depart_date: '2025-06-10',
                    return_date: '2025-06-25',
                    created_at: '2024-11-06', updated_at: '2024-12-01'
                },
                {
                    id: 3, group_id: 1, manager_id: 2,
                    latin_first_name: 'Zhanara', latin_last_name: 'Smagulova',
                    phone: '+77011111112', iin: '123456789014', messenger: 'whatsapp', status: 'training',
                    visa_required: 'VIZA BAR', nabor_size: 'M', comment: '–∏–Ω–≤ –∫–æ–ª—è—Å–∫–∞',
                    hotel_name: 'Swissotel Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'DB', board_type: '–ó–∞–≤—Ç—Ä–∞–∫',
                    transfer_type: 'BUSINESS TRAIN', tour_price_usd: 6200,
                    passport_number: 'N23456789', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '1975-08-20',
                    passport_gender: '–ñ', passport_issue_date: '2019-06-15', 
                    passport_expiry_date: '2029-06-15',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: false,
                    room_lead_id: null, // –õ–∏–¥–µ—Ä —Å–≤–æ–µ–π –∫–æ–º–Ω–∞—Ç—ã
                    booking_lead_id: 1, // –í –∑–∞—è–≤–∫–µ –ê—Å—ã–ª—Ö–∞–Ω–∞
                    parent_id: null,
                    depart_date: '2025-06-10',
                    return_date: '2025-06-25',
                    created_at: '2024-11-10', updated_at: '2024-11-28'
                },
                {
                    id: 4, group_id: 1, manager_id: 2,
                    latin_first_name: 'Aida', latin_last_name: 'Smagulova',
                    phone: '+77011111120', iin: '123456789015', messenger: 'whatsapp', status: 'training',
                    visa_required: 'VIZA BAR', nabor_size: 'S', comment: '–°–µ—Å—Ç—Ä–∞ –ñ–∞–Ω–∞—Ä—ã',
                    hotel_name: 'Swissotel Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'DB', board_type: '–ó–∞–≤—Ç—Ä–∞–∫',
                    transfer_type: 'BUSINESS TRAIN', tour_price_usd: 6200,
                    passport_number: 'N23456790', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '1978-11-05',
                    passport_gender: '–ñ', passport_issue_date: '2019-07-20', 
                    passport_expiry_date: '2029-07-20',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: false,
                    room_lead_id: 3, // –°–æ—Å–µ–¥ –ñ–∞–Ω–∞—Ä—ã
                    booking_lead_id: 1, // –í –∑–∞—è–≤–∫–µ –ê—Å—ã–ª—Ö–∞–Ω–∞
                    parent_id: null,
                    depart_date: '2025-06-10',
                    return_date: '2025-06-25',
                    created_at: '2024-11-11', updated_at: '2024-11-28'
                },
                {
                    id: 5, group_id: 1, manager_id: 2,
                    latin_first_name: 'Amina', latin_last_name: 'Nurbekova',
                    phone: '+77011111121', iin: '123456789016', messenger: 'whatsapp', status: 'new',
                    visa_required: 'YES', nabor_size: 'XS', comment: '–î–æ—á—å –ê—Å—ã–ª—Ö–∞–Ω–∞, 8 –ª–µ—Ç',
                    hotel_name: 'Hilton Makkah', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'DB', board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: 'BUS', tour_price_usd: 4500,
                    passport_number: 'N12345680', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '2016-03-15',
                    passport_gender: '–ñ', passport_issue_date: '2023-01-10', 
                    passport_expiry_date: '2033-01-10',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: false,
                    room_lead_id: 1, // –í –∫–æ–º–Ω–∞—Ç–µ —Å –æ—Ç—Ü–æ–º
                    booking_lead_id: 1, // –í –∑–∞—è–≤–∫–µ –æ—Ç—Ü–∞
                    parent_id: 1, // –†–æ–¥–∏—Ç–µ–ª—å - –ê—Å—ã–ª—Ö–∞–Ω
                    child_type: 'CHILD',
                    depart_date: '2025-06-10',
                    return_date: '2025-06-25',
                    created_at: '2024-11-12', updated_at: '2024-12-01'
                },
                {
                    id: 6, group_id: 2, manager_id: 5,
                    latin_first_name: 'Erbol', latin_last_name: 'Kenzhebaev',
                    phone: '+77011111113', iin: '123456789017', messenger: 'whatsapp', status: 'flying',
                    visa_required: 'YES', nabor_size: 'XL', comment: '',
                    hotel_name: 'Pullman Zamzam', hotel_type: '5 –∑–≤–µ–∑–¥', 
                    room_type: 'TRP', board_type: '–ü–æ–ª—É–ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: 'TRAIN', tour_price_usd: 3800,
                    passport_number: 'N34567890', passport_citizenship: '–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω', 
                    passport_birth_date: '1985-12-05',
                    passport_gender: '–ú', passport_issue_date: '2021-01-20', 
                    passport_expiry_date: '2031-01-20',
                    passport_authority: '–ú–í–î –†–ö', passport_photo_url: '', 
                    passport_verified: true,
                    room_lead_id: null, // –õ–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
                    booking_lead_id: null, // –õ–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏
                    parent_id: null,
                    depart_date: '2025-01-15',
                    return_date: '2025-01-22',
                    created_at: '2024-11-20', updated_at: '2024-12-05'
                }
            ];

            // Documents
            state.documents = [
                { id: 1, pilgrim_id: 1, type: 'passport', file_url: 'passport_1.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'ready_to_send', uploaded_by_user_id: 3, uploaded_at: '2024-11-05' },
                { id: 2, pilgrim_id: 1, type: 'visa', file_url: 'visa_1.pdf', original_name: '–í–∏–∑–∞ –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'sent', uploaded_by_user_id: 2, uploaded_at: '2024-11-20' },
                { id: 3, pilgrim_id: 1, type: 'insurance', file_url: 'insurance_1.pdf', original_name: '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ê—Å—ã–ª—Ö–∞–Ω–∞.pdf', status: 'sent', uploaded_by_user_id: 2, uploaded_at: '2024-11-22' },
                { id: 4, pilgrim_id: 2, type: 'passport', file_url: 'passport_2.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ù—É—Ä–±–µ–∫–∞.pdf', status: 'ready_to_send', uploaded_by_user_id: 3, uploaded_at: '2024-11-06' },
                { id: 5, pilgrim_id: 3, type: 'passport', file_url: 'passport_3.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ñ–∞–Ω–∞—Ä—ã.pdf', status: 'preparing', uploaded_by_user_id: 3, uploaded_at: '2024-11-10' },
                { id: 6, pilgrim_id: 4, type: 'passport', file_url: 'passport_4.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ê–∏–¥—ã.pdf', status: 'preparing', uploaded_by_user_id: 3, uploaded_at: '2024-11-11' },
                { id: 7, pilgrim_id: 5, type: 'passport', file_url: 'passport_5.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ê–º–∏–Ω—ã.pdf', status: 'preparing', uploaded_by_user_id: 3, uploaded_at: '2024-11-12' },
                { id: 8, pilgrim_id: 6, type: 'passport', file_url: 'passport_6.pdf', original_name: '–ü–∞—Å–ø–æ—Ä—Ç –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 3, uploaded_at: '2024-11-20' },
                { id: 9, pilgrim_id: 6, type: 'visa', file_url: 'visa_6.pdf', original_name: '–í–∏–∑–∞ –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 5, uploaded_at: '2024-12-01' },
                { id: 10, pilgrim_id: 6, type: 'ticket', file_url: 'ticket_6.pdf', original_name: '–ë–∏–ª–µ—Ç –ï—Ä–±–æ–ª–∞.pdf', status: 'sent', uploaded_by_user_id: 5, uploaded_at: '2024-12-03' }
            ];

            // Payments - Updated with dual currency
            state.payments = [
                { 
                    id: 1, pilgrim_id: 1, type: 'prepayment', 
                    amount_usd: 2000, amount_kzt: 900000, exchange_rate: 450, currency_source: 'kzt',
                    paid_at: '2024-11-05', created_by_user_id: 3, comment: '–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –∑–∞ –≤—Å—é –∑–∞—è–≤–∫—É' 
                },
                { 
                    id: 2, pilgrim_id: 1, type: 'extra', 
                    amount_usd: 1500, amount_kzt: 675000, exchange_rate: 450, currency_source: 'kzt',
                    paid_at: '2024-11-20', created_by_user_id: 4, comment: '–í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å –æ–ø–ª–∞—Ç—ã' 
                },
                { 
                    id: 3, pilgrim_id: 1, type: 'extra', 
                    amount_usd: 2000, amount_kzt: 0, exchange_rate: 450, currency_source: 'usd',
                    paid_at: '2024-12-01', created_by_user_id: 4, comment: '–§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞' 
                },
                { 
                    id: 4, pilgrim_id: 3, type: 'prepayment', 
                    amount_usd: 3000, amount_kzt: 1350000, exchange_rate: 450, currency_source: 'kzt',
                    paid_at: '2024-11-10', created_by_user_id: 3, comment: '–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' 
                },
                { 
                    id: 5, pilgrim_id: 6, type: 'prepayment', 
                    amount_usd: 1500, amount_kzt: 675000, exchange_rate: 450, currency_source: 'kzt',
                    paid_at: '2024-11-20', created_by_user_id: 3, comment: '–ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å' 
                },
                { 
                    id: 6, pilgrim_id: 6, type: 'extra', 
                    amount_usd: 2300, amount_kzt: 1035000, exchange_rate: 450, currency_source: 'kzt',
                    paid_at: '2024-12-05', created_by_user_id: 4, comment: '–ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞' 
                }
            ];

            // Message Templates
            state.message_templates = [
                {
                    id: 1, name: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –≤—ã–ª–µ—Ç–∞', trigger_type: 'time_before_departure',
                    trigger_key: 'before_departure', offset_days: -7, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {latin_first_name}! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π {depart_date} —Å–æ—Å—Ç–æ–∏—Ç—Å—è –≤–∞—à –≤—ã–ª–µ—Ç. –û—Ç–µ–ª—å: {hotel_name}. –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º: {manager_name}.',
                    variables: {}, can_attach_file: false, is_active: true, created_at: '2024-10-01'
                },
                {
                    id: 2, name: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–∑—ã', trigger_type: 'document_based',
                    trigger_key: 'visa_ready', offset_days: 0, offset_hours: 0, offset_minutes: 0,
                    document_type: 'visa', channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {latin_first_name}! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É. –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏–ª–∞–≥–∞–µ—Ç—Å—è.',
                    variables: {}, can_attach_file: true, is_active: true, created_at: '2024-10-05'
                },
                {
                    id: 3, name: '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å –¥–æ –ø—Ä–∏–ª—ë—Ç–∞', trigger_type: 'time_before_arrival',
                    trigger_key: 'before_arrival', offset_days: -1, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {latin_first_name}! –ó–∞–≤—Ç—Ä–∞ {return_date} –≤–∞—à —Ä–µ–π—Å –¥–æ–º–æ–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ –±–∞–≥–∞–∂.',
                    variables: {}, can_attach_file: false, is_active: true, created_at: '2024-10-10'
                },
                {
                    id: 4, name: '–†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', trigger_type: 'manual',
                    trigger_key: 'manual', offset_days: 0, offset_hours: 0, offset_minutes: 0,
                    document_type: null, channel: 'whatsapp',
                    body: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, {latin_first_name}! –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {manager_name}.',
                    variables: {}, can_attach_file: true, is_active: true, created_at: '2024-10-15'
                }
            ];

            // Message Logs
            state.message_logs = [
                {
                    id: 1, pilgrim_id: 1, template_id: 1, sent_by_user_id: null, channel: 'whatsapp',
                    status: 'sent', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, Asylkhan! –ù–∞–ø–æ–º–∏–Ω–∞–µ–º...',
                    attachment_url: null, sent_at: '2024-12-03T10:00:00'
                },
                {
                    id: 2, pilgrim_id: 1, template_id: 2, sent_by_user_id: 2, channel: 'whatsapp',
                    status: 'delivered', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, Asylkhan! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞...',
                    attachment_url: 'visa_1.pdf', sent_at: '2024-11-20T14:30:00'
                },
                {
                    id: 3, pilgrim_id: 6, template_id: 2, sent_by_user_id: 5, channel: 'whatsapp',
                    status: 'sent', body_rendered: '–ê—Å—Å–∞–ª–∞—É–º–∞“ì–∞–ª–µ–π–∫—É–º, Erbol! –í–∞—à–∞ –≤–∏–∑–∞ –≥–æ—Ç–æ–≤–∞...',
                    attachment_url: 'visa_6.pdf', sent_at: '2024-12-01T16:00:00'
                }
            ];
        }

        // Initialize UI
        function initUI() {
            initData();
            renderDashboard();
            renderGroupsAndPilgrims();
            renderTemplatesPage();
            renderManagersPage();
            renderSchedulePage();
            renderDocumentsPage();
            updateFilterDropdowns();
            loadSettings();
        }

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById('page-' + pageId).classList.add('active');
            
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-item').classList.add('active');
            
            // Render page content
            if (pageId === 'dashboard') renderDashboard();
            if (pageId === 'groups') renderGroupsAndPilgrims();
            if (pageId === 'templates') renderTemplatesPage();
            if (pageId === 'managers') renderManagersPage();
            if (pageId === 'schedule') renderSchedulePage();
            if (pageId === 'documents') renderDocumentsPage();
            if (pageId === 'settings') loadSettings();
        }

        // Role Management
        function toggleRoleDropdown() {
            const dropdown = document.getElementById('roleDropdown');
            dropdown.classList.toggle('show');
        }

        function switchRole(role, roleName) {
            state.currentRole = role;
            state.currentRoleName = roleName;
            document.getElementById('currentRole').textContent = roleName;
            document.getElementById('roleDropdown').classList.remove('show');
            
            // Re-render current page to reflect role permissions
            const activePage = document.querySelector('.page-section.active');
            if (activePage.id === 'page-groups') {
                renderSelectedPilgrim();
            }
            if (activePage.id === 'page-dashboard') {
                renderDashboard();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.role-badge')) {
                document.getElementById('roleDropdown').classList.remove('show');
            }
        });

        // Dashboard
        function renderDashboard() {
            updateDashboard();
        }

        function updateDashboard() {
            updateMetrics();
            updateKanban();
            updatePilgrimTable();
        }

        function updateMetrics() {
            const filterMonth = document.getElementById('filterMonth').value;
            const filterCity = document.getElementById('filterCity').value;
            const filterGroup = document.getElementById('filterGroup').value;
            
            let filteredGroups = state.service_groups;
            let filteredPilgrims = state.pilgrims;
            
            // Apply filters
            if (filterCity) {
                filteredGroups = filteredGroups.filter(g => 
                    g.depart_route && g.depart_route.startsWith(filterCity)
                );
            }
            
            if (filterGroup) {
                filteredGroups = filteredGroups.filter(g => g.id == filterGroup);
            }
            
            // Get pilgrims from filtered groups
            const groupIds = filteredGroups.map(g => g.id);
            filteredPilgrims = filteredPilgrims.filter(p => groupIds.includes(p.group_id));
            
            // Apply month filter if needed
            if (filterMonth === 'current') {
                const now = new Date();
                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                
                filteredGroups = filteredGroups.filter(g => {
                    const departDate = new Date(g.depart_date);
                    return departDate.getMonth() + 1 === currentMonth && 
                           departDate.getFullYear() === currentYear;
                });
                
                const filteredGroupIds = filteredGroups.map(g => g.id);
                filteredPilgrims = filteredPilgrims.filter(p => filteredGroupIds.includes(p.group_id));
            }
            
            // Calculate metrics
            const activeGroups = filteredGroups.filter(g => ['preparing', 'flying', 'in_trip'].includes(g.status)).length;
            const totalPilgrims = filteredPilgrims.length;
            
            // Calculate rooms and bookings
            const roomLeaders = filteredPilgrims.filter(p => p.room_lead_id === null).length;
            const bookingLeaders = filteredPilgrims.filter(p => p.booking_lead_id === null).length;
            
            // Count children
            const childrenCount = filteredPilgrims.filter(p => p.parent_id !== null).length;
            const children = filteredPilgrims.filter(p => p.parent_id !== null);
            const childCount = children.filter(p => p.child_type === 'CHILD').length;
            const infantCount = children.filter(p => p.child_type === 'INFANT').length;
            
            // Visa statistics
            const pilgrimsNoVisaNeeded = filteredPilgrims.filter(p => p.visa_required === 'VIZA BAR').length;
            const pilgrimsNoVisa = filteredPilgrims.filter(p => {
                return p.visa_required === 'YES' && !state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa');
            }).length;
            
            const pilgrimsWithVisa = filteredPilgrims.filter(p => {
                return p.visa_required === 'YES' && state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status !== 'sent');
            }).length;
            
            const pilgrimsVisaSent = filteredPilgrims.filter(p => {
                return p.visa_required === 'YES' && state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status === 'sent');
            }).length;
            
            // Financial statistics
            const pilgrimIds = filteredPilgrims.map(p => p.id);
            const filteredPayments = state.payments.filter(p => pilgrimIds.includes(p.pilgrim_id));
            
            const totalPrepaymentsUSD = filteredPayments
                .filter(p => p.type === 'prepayment')
                .reduce((sum, p) => sum + (p.amount_usd || 0), 0);
            
            const totalExtraUSD = filteredPayments
                .filter(p => p.type === 'extra')
                .reduce((sum, p) => sum + (p.amount_usd || 0), 0);
            
            const totalTourPriceUSD = filteredPilgrims
                .reduce((sum, p) => sum + (p.tour_price_usd || 0), 0);
            
            const totalRemainingUSD = totalTourPriceUSD - totalPrepaymentsUSD - totalExtraUSD;
            
            // Update metrics display
            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã</div>
                    <div class="metric-value">${activeGroups}</div>
                    <div class="metric-sublabel">–∏–∑ ${filteredGroups.length} –≤—Å–µ–≥–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ü–∞–ª–æ–º–Ω–∏–∫–∏</div>
                    <div class="metric-value">${totalPilgrims}</div>
                    <div class="metric-sublabel">–≤—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ö–æ–º–Ω–∞—Ç—ã</div>
                    <div class="metric-value">${roomLeaders}</div>
                    <div class="metric-sublabel">–æ—Ç–¥–µ–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ó–∞—è–≤–∫–∏</div>
                    <div class="metric-value">${bookingLeaders}</div>
                    <div class="metric-sublabel">—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–î–µ—Ç–∏/–ò–Ω—Ñ–∞–Ω—Ç—ã</div>
                    <div class="metric-value">${childrenCount}</div>
                    <div class="metric-sublabel">CHILD: ${childCount}, INFANT: ${infantCount}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–í–∏–∑–∞ –Ω–µ –Ω—É–∂–Ω–∞</div>
                    <div class="metric-value" style="color: var(--success);">${pilgrimsNoVisaNeeded}</div>
                    <div class="metric-sublabel">VIZA BAR</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ù–µ—Ç –≤–∏–∑—ã</div>
                    <div class="metric-value" style="color: var(--danger);">${pilgrimsNoVisa}</div>
                    <div class="metric-sublabel">—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–í–∏–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</div>
                    <div class="metric-value" style="color: var(--warning);">${pilgrimsWithVisa}</div>
                    <div class="metric-sublabel">–≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–í–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</div>
                    <div class="metric-value" style="color: var(--success);">${pilgrimsVisaSent}</div>
                    <div class="metric-sublabel">–ø–∞–ª–æ–º–Ω–∏–∫–∏ –≥–æ—Ç–æ–≤—ã</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç—ã</div>
                    <div class="metric-value" style="color: var(--success);">$${totalPrepaymentsUSD.toLocaleString()}</div>
                    <div class="metric-sublabel">–ø–æ–ª—É—á–µ–Ω–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–î–æ–ø–ª–∞—Ç—ã</div>
                    <div class="metric-value" style="color: var(--success);">$${totalExtraUSD.toLocaleString()}</div>
                    <div class="metric-sublabel">–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å</div>
                    <div class="metric-value" style="color: var(--warning);">$${totalRemainingUSD.toLocaleString()}</div>
                    <div class="metric-sublabel">–∫ –ø–æ–ª—É—á–µ–Ω–∏—é</div>
                </div>
            `;
            document.getElementById('metricsGrid').innerHTML = metricsHTML;
        }

        function switchDashboardMode(mode) {
            state.dashboardMode = mode;
            
            document.getElementById('toggleKanban').classList.toggle('active', mode === 'kanban');
            document.getElementById('toggleTable').classList.toggle('active', mode === 'table');
            
            document.getElementById('dashboardKanban').style.display = mode === 'kanban' ? 'block' : 'none';
            document.getElementById('dashboardTable').style.display = mode === 'table' ? 'block' : 'none';
            
            if (mode === 'kanban') {
                updateKanban();
            } else {
                updatePilgrimTable();
            }
        }

        function updateKanban() {
            const kanbanStatuses = ['new', 'preparing', 'flying', 'in_trip', 'finished'];
            const statusLabels = {
                'new': '–ù–æ–≤–∞—è',
                'preparing': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
                'flying': '–í –ø—É—Ç–∏',
                'in_trip': '–í –ø–æ–µ–∑–¥–∫–µ',
                'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω–∞'
            };
            
            let kanbanHTML = '';
            
            kanbanStatuses.forEach(status => {
                const groupsInStatus = state.service_groups.filter(g => g.status === status);
                
                kanbanHTML += `
                    <div class="kanban-column">
                        <div class="kanban-header">${statusLabels[status]} (${groupsInStatus.length})</div>
                `;
                
                groupsInStatus.forEach(group => {
                    const pilgrimsInGroup = state.pilgrims.filter(p => p.group_id === group.id);
                    const managers = [...new Set(pilgrimsInGroup.map(p => {
                        const manager = state.users.find(u => u.id === p.manager_id);
                        return manager ? manager.name : '';
                    }).filter(name => name))];
                    
                    // Document status checks
                    const allPilgrimsHavePassport = pilgrimsInGroup.every(p => 
                        state.documents.some(d => d.pilgrim_id === p.id && d.type === 'passport')
                    );
                    
                    const allPilgrimsHaveVisa = pilgrimsInGroup.filter(p => p.visa_required === 'YES').every(p => 
                        state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa')
                    );
                    
                    const allPilgrimsHaveVoucher = pilgrimsInGroup.every(p => 
                        state.documents.some(d => d.pilgrim_id === p.id && d.type === 'voucher')
                    );
                    
                    const allPilgrimsHaveClothing = pilgrimsInGroup.filter(p => p.nabor_size !== 'NO').every(p => 
                        state.documents.some(d => d.pilgrim_id === p.id && d.original_name && d.original_name.includes('–æ–¥–µ–∂–¥'))
                    );
                    
                    // Count rooms, bookings, and children
                    const rooms = pilgrimsInGroup.filter(p => p.room_lead_id === null).length;
                    const bookings = pilgrimsInGroup.filter(p => p.booking_lead_id === null).length;
                    const children = pilgrimsInGroup.filter(p => p.parent_id !== null).length;
                    
                    kanbanHTML += `
                        <div class="kanban-card" draggable="true" ondragstart="dragGroup(event, ${group.id})" onclick="openGroupDetails(${group.id})">
                            <div class="kanban-card-title">${group.name}</div>
                            <div class="kanban-card-meta">
                                ${formatDate(group.depart_date)} - ${formatDate(group.return_date)}<br>
                                ${group.depart_route} / ${group.return_route}<br>
                                ${group.airline}<br>
                                üë• ${pilgrimsInGroup.length} –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤<br>
                                üè® ${rooms} –∫–æ–º–Ω–∞—Ç / üìã ${bookings} –∑–∞—è–≤–æ–∫<br>
                                üë∂ ${children} –¥–µ—Ç–µ–π<br>
                                ${managers.length > 0 ? `üë§ ${managers.join(', ')}` : ''}
                            </div>
                            <div class="doc-status">
                                <div class="doc-status-item">üìÑ ${allPilgrimsHavePassport ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                                <div class="doc-status-item">üõÇ ${allPilgrimsHaveVisa ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                                <div class="doc-status-item">üè® ${allPilgrimsHaveVoucher ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                                <div class="doc-status-item">üëï ${allPilgrimsHaveClothing ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                            </div>
                        </div>
                    `;
                });
                
                kanbanHTML += `</div>`;
            });
            
            document.getElementById('kanbanContainer').innerHTML = kanbanHTML;
            
            // Make columns droppable
            document.querySelectorAll('.kanban-column').forEach((column, index) => {
                column.ondragover = (e) => e.preventDefault();
                column.ondrop = (e) => {
                    e.preventDefault();
                    const groupId = e.dataTransfer.getData('text/plain');
                    const newStatus = kanbanStatuses[index];
                    updateGroupStatus(groupId, newStatus);
                };
            });
        }

        function dragGroup(event, groupId) {
            event.dataTransfer.setData('text/plain', groupId);
        }

        function updateGroupStatus(groupId, newStatus) {
            const group = state.service_groups.find(g => g.id == groupId);
            if (group) {
                group.status = newStatus;
                updateKanban();
                updateDashboard();
            }
        }

        function openGroupDetails(groupId) {
            state.selectedGroupId = groupId;
            showPage('groups');
            renderGroupsAndPilgrims();
        }

        function updatePilgrimTable() {
            const searchText = document.getElementById('tableSearch').value.toLowerCase();
            const visaFilter = document.getElementById('tableVisaFilter').value;
            const paymentFilter = document.getElementById('tablePaymentFilter').value;
            
            let filteredPilgrims = state.pilgrims;
            
            // Apply search filter
            if (searchText) {
                filteredPilgrims = filteredPilgrims.filter(p => 
                    `${p.latin_first_name} ${p.latin_last_name}`.toLowerCase().includes(searchText) ||
                    p.phone.toLowerCase().includes(searchText) ||
                    p.iin.includes(searchText)
                );
            }
            
            // Apply visa filter
            if (visaFilter) {
                if (visaFilter === 'not_required') {
                    filteredPilgrims = filteredPilgrims.filter(p => p.visa_required === 'VIZA BAR');
                } else if (visaFilter === 'no') {
                    filteredPilgrims = filteredPilgrims.filter(p => 
                        p.visa_required === 'YES' && 
                        !state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa')
                    );
                } else if (visaFilter === 'uploaded') {
                    filteredPilgrims = filteredPilgrims.filter(p => 
                        p.visa_required === 'YES' && 
                        state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status !== 'sent')
                    );
                } else if (visaFilter === 'sent') {
                    filteredPilgrims = filteredPilgrims.filter(p => 
                        p.visa_required === 'YES' && 
                        state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa' && d.status === 'sent')
                    );
                }
            }
            
            // Apply payment filter
            if (paymentFilter) {
                filteredPilgrims = filteredPilgrims.filter(p => {
                    const pilgrimPayments = state.payments.filter(pay => pay.pilgrim_id === p.id);
                    const totalPaid = pilgrimPayments.reduce((sum, pay) => sum + (pay.amount_usd || 0), 0);
                    const remaining = (p.tour_price_usd || 0) - totalPaid;
                    
                    if (paymentFilter === 'pending') return remaining > 0;
                    if (paymentFilter === 'paid') return remaining <= 0;
                    return true;
                });
            }
            
            // Build table
            let tableHTML = '';
            
            filteredPilgrims.forEach(pilgrim => {
                const group = state.service_groups.find(g => g.id === pilgrim.group_id);
                const manager = state.users.find(u => u.id === pilgrim.manager_id);
                const lastMessage = state.message_logs
                    .filter(m => m.pilgrim_id === pilgrim.id)
                    .sort((a, b) => new Date(b.sent_at) - new Date(a.sent_at))[0];
                
                // Calculate payment status
                const pilgrimPayments = state.payments.filter(p => p.pilgrim_id === pilgrim.id);
                const totalPaid = pilgrimPayments.reduce((sum, p) => sum + (p.amount_usd || 0), 0);
                const remaining = (pilgrim.tour_price_usd || 0) - totalPaid;
                
                // Determine visa status
                let visaStatus = '';
                if (pilgrim.visa_required === 'VIZA BAR') {
                    visaStatus = '–ù–µ –Ω—É–∂–Ω–∞';
                } else {
                    const visaDoc = state.documents.find(d => d.pilgrim_id === pilgrim.id && d.type === 'visa');
                    if (!visaDoc) {
                        visaStatus = '–ù–µ—Ç';
                    } else if (visaDoc.status === 'sent') {
                        visaStatus = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞';
                    } else {
                        visaStatus = '–ó–∞–≥—Ä—É–∂–µ–Ω–∞';
                    }
                }
                
                // Get departure city from route
                const departureCity = group && group.depart_route ? 
                    group.depart_route.split('-')[0] : '';
                
                // Room, booking, and family info
                let roomInfo = '';
                let bookingInfo = '';
                let familyInfo = '';
                
                if (pilgrim.room_lead_id === null) {
                    const roommates = state.pilgrims.filter(p => p.room_lead_id === pilgrim.id);
                    roomInfo = `–õ–∏–¥–µ—Ä (${roommates.length + 1} —á–µ–ª.)`;
                } else {
                    const roomLeader = state.pilgrims.find(p => p.id === pilgrim.room_lead_id);
                    roomInfo = roomLeader ? `–°–æ—Å–µ–¥: ${roomLeader.latin_first_name}` : '–°–æ—Å–µ–¥';
                }
                
                if (pilgrim.booking_lead_id === null) {
                    const bookingMembers = state.pilgrims.filter(p => p.booking_lead_id === pilgrim.id);
                    bookingInfo = `–õ–∏–¥–µ—Ä (${bookingMembers.length} —á–µ–ª.)`;
                } else {
                    const bookingLeader = state.pilgrims.find(p => p.id === pilgrim.booking_lead_id);
                    bookingInfo = bookingLeader ? `–í –∑–∞—è–≤–∫–µ: ${bookingLeader.latin_first_name}` : '–í –∑–∞—è–≤–∫–µ';
                }
                
                // Family info
                if (pilgrim.parent_id !== null) {
                    const parent = state.pilgrims.find(p => p.id === pilgrim.parent_id);
                    familyInfo = `–†–æ–¥–∏—Ç–µ–ª—å: ${parent ? parent.latin_first_name : ''}`;
                } else {
                    const children = state.pilgrims.filter(p => p.parent_id === pilgrim.id);
                    if (children.length > 0) {
                        familyInfo = `–î–µ—Ç–µ–π: ${children.length}`;
                    }
                }
                
                tableHTML += `
                    <tr>
                        <td>
                            ${pilgrim.latin_first_name} ${pilgrim.latin_last_name}
                            ${pilgrim.room_lead_id === null ? '<span class="room-badge">üè® –õ–∏–¥–µ—Ä</span>' : ''}
                            ${pilgrim.booking_lead_id === null ? '<span class="booking-badge">üìã –õ–∏–¥–µ—Ä</span>' : ''}
                            ${pilgrim.parent_id === null && state.pilgrims.some(p => p.parent_id === pilgrim.id) ? '<span class="family-badge">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –†–æ–¥–∏—Ç–µ–ª—å</span>' : ''}
                            ${pilgrim.parent_id !== null ? `<span class="${pilgrim.child_type === 'CHILD' ? 'child-badge' : 'infant-badge'}">${pilgrim.child_type || '–†–ï–ë–Å–ù–û–ö'}</span>` : ''}
                        </td>
                        <td>${group ? group.name : '-'}</td>
                        <td>${roomInfo}</td>
                        <td>${bookingInfo}</td>
                        <td>${familyInfo}</td>
                        <td>${group ? `${group.depart_route} / ${group.return_route}` : '-'}</td>
                        <td>${manager ? manager.name : '-'}</td>
                        <td><span class="status-badge status-${pilgrim.status}">${getStatusName(pilgrim.status)}</span></td>
                        <td>${departureCity}</td>
                        <td>${formatDate(pilgrim.depart_date)}</td>
                        <td>${formatDate(pilgrim.return_date)}</td>
                        <td>
                            ${visaStatus === '–ù–µ –Ω—É–∂–Ω–∞' ? 
                                '<span class="status-badge status-viza-bar">VIZA BAR</span>' : 
                                visaStatus}
                        </td>
                        <td>
                            <strong>$${totalPaid.toLocaleString()} / $${remaining.toLocaleString()}</strong>
                        </td>
                        <td>
                            ${lastMessage ? 
                                `${formatDate(lastMessage.sent_at)}<br><small>${getTemplateName(lastMessage.template_id)}</small>` : 
                                '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${pilgrim.id}); showPage('groups')">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('pilgrimsTableBody').innerHTML = tableHTML || 
                '<tr><td colspan="15" style="text-align: center; color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }

        // Groups & Pilgrims
        function renderGroupsAndPilgrims() {
            renderGroupsList();
            renderPilgrimsList();
            if (state.selectedPilgrimId) {
                renderSelectedPilgrim();
            } else {
                document.getElementById('pilgrimDetail').innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p></div>';
            }
        }

        function renderGroupsList() {
            let html = '';
            state.service_groups.forEach(group => {
                const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                const isSelected = state.selectedGroupId === group.id;
                
                // Document checkpoints
                const pilgrimsInGroup = state.pilgrims.filter(p => p.group_id === group.id);
                const passportOk = pilgrimsInGroup.every(p => 
                    state.documents.some(d => d.pilgrim_id === p.id && d.type === 'passport')
                );
                const visaOk = pilgrimsInGroup.filter(p => p.visa_required === 'YES').every(p => 
                    state.documents.some(d => d.pilgrim_id === p.id && d.type === 'visa')
                );
                const voucherOk = pilgrimsInGroup.every(p => 
                    state.documents.some(d => d.pilgrim_id === p.id && d.type === 'voucher')
                );
                const clothingOk = pilgrimsInGroup.filter(p => p.nabor_size !== 'NO').every(p => 
                    state.documents.some(d => d.pilgrim_id === p.id && d.original_name && d.original_name.includes('–æ–¥–µ–∂–¥'))
                );
                
                // Count rooms, bookings, and children
                const rooms = pilgrimsInGroup.filter(p => p.room_lead_id === null).length;
                const bookings = pilgrimsInGroup.filter(p => p.booking_lead_id === null).length;
                const children = pilgrimsInGroup.filter(p => p.parent_id !== null).length;
                
                html += `
                    <div class="list-item ${isSelected ? 'selected' : ''}" onclick="selectGroup(${group.id})">
                        <div class="list-item-title">${group.name}</div>
                        <div class="list-item-meta">
                            ${formatDate(group.depart_date)} - ${formatDate(group.return_date)}<br>
                            ${group.depart_route} ‚Üí ${group.return_route}<br>
                            ${group.airline}<br>
                            <span class="status-badge status-${group.status}">${getStatusName(group.status)}</span>
                            <span style="margin-left: 8px;">üë• ${pilgrimsCount}</span>
                            <span style="margin-left: 8px;">üè® ${rooms}</span>
                            <span style="margin-left: 8px;">üìã ${bookings}</span>
                            ${children > 0 ? `<span style="margin-left: 8px;">üë∂ ${children}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: 8px; font-size: 12px;">
                            <span>üìÑ ${passportOk ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span>üõÇ ${visaOk ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span>üè® ${voucherOk ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span>üëï ${clothingOk ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        </div>
                    </div>
                `;
            });
            document.getElementById('groupsList').innerHTML = html;
        }

        function selectGroup(groupId) {
            state.selectedGroupId = groupId;
            state.selectedPilgrimId = null;
            renderGroupsList();
            renderPilgrimsList();
            document.getElementById('pilgrimDetail').innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</p></div>';
        }

        function renderPilgrimsList() {
            const container = document.getElementById('pilgrimsList');
            
            if (!state.selectedGroupId && !state.showAllPilgrims) {
                container.innerHTML = '<div class="placeholder"><p>–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É —Å–ª–µ–≤–∞</p></div>';
                return;
            }
            
            let pilgrims = state.pilgrims;
            if (!state.showAllPilgrims && state.selectedGroupId) {
                pilgrims = pilgrims.filter(p => p.group_id === state.selectedGroupId);
            }
            
            const group = state.service_groups.find(g => g.id === state.selectedGroupId);
            
            // Group pilgrims by room and booking
            const rooms = {};
            const bookings = {};
            
            pilgrims.forEach(pilgrim => {
                // Group by room
                const roomKey = pilgrim.room_lead_id || pilgrim.id;
                if (!rooms[roomKey]) {
                    rooms[roomKey] = [];
                }
                rooms[roomKey].push(pilgrim);
                
                // Group by booking
                const bookingKey = pilgrim.booking_lead_id || pilgrim.id;
                if (!bookings[bookingKey]) {
                    bookings[bookingKey] = [];
                }
                bookings[bookingKey].push(pilgrim);
            });
            
            let html = '';
            if (state.selectedGroupId) {
                html = `<div style="padding: 12px; background: var(--bg-main); margin-bottom: 12px; border-radius: 6px;">
                    <strong>–ì—Ä—É–ø–ø–∞:</strong> ${group.name}<br>
                    <strong>–ü–∞–ª–æ–º–Ω–∏–∫–æ–≤:</strong> ${pilgrims.length}<br>
                    <strong>–ö–æ–º–Ω–∞—Ç:</strong> ${Object.keys(rooms).length}<br>
                    <strong>–ó–∞—è–≤–æ–∫:</strong> ${Object.keys(bookings).length}<br>
                    <strong>–î–∞—Ç—ã:</strong> ${formatDate(group.depart_date)} - ${formatDate(group.return_date)}
                </div>`;
            } else {
                html = `<div style="padding: 12px; background: var(--bg-main); margin-bottom: 12px; border-radius: 6px;">
                    <strong>–í—Å–µ –ø–∞–ª–æ–º–Ω–∏–∫–∏:</strong> ${pilgrims.length}<br>
                    <strong>–ö–æ–º–Ω–∞—Ç:</strong> ${Object.keys(rooms).length}<br>
                    <strong>–ó–∞—è–≤–æ–∫:</strong> ${Object.keys(bookings).length}<br>
                    <strong>–†–µ–∂–∏–º:</strong> –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –≥—Ä—É–ø–ø
                </div>`;
            }
            
            // Display pilgrims grouped by room
            Object.values(rooms).forEach(roomPilgrims => {
                const roomLeader = roomPilgrims.find(p => p.room_lead_id === null) || roomPilgrims[0];
                const bookingLeader = state.pilgrims.find(p => p.id === roomLeader.booking_lead_id) || roomLeader;
                const groupInfo = state.service_groups.find(g => g.id === roomLeader.group_id);
                
                html += `<div style="margin-bottom: 12px; padding: 8px; background: #f0f9ff; border-radius: 6px; border-left: 3px solid var(--primary);">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                        üè® ${roomLeader.hotel_name} (${roomLeader.room_type})
                        ${roomLeader.booking_lead_id !== null ? `‚Ä¢ üìã –í –∑–∞—è–≤–∫–µ: ${bookingLeader.latin_first_name}` : ''}
                        ${state.showAllPilgrims ? `‚Ä¢ üë• ${groupInfo ? groupInfo.name : '–ì—Ä—É–ø–ø–∞ ' + roomLeader.group_id}` : ''}
                    </div>`;
                
                roomPilgrims.forEach(pilgrim => {
                    const isSelected = state.selectedPilgrimId === pilgrim.id;
                    const hasVisa = pilgrim.visa_required === 'YES' ? 
                        state.documents.some(d => d.pilgrim_id === pilgrim.id && d.type === 'visa') : 
                        true;
                    
                    html += `
                        <div class="list-item ${isSelected ? 'selected' : ''}" onclick="selectPilgrim(${pilgrim.id})" style="margin-bottom: 4px;">
                            <div class="list-item-title">
                                ${pilgrim.latin_first_name} ${pilgrim.latin_last_name}
                                ${pilgrim.room_lead_id === null ? '<span class="room-badge">üè®</span>' : ''}
                                ${pilgrim.booking_lead_id === null ? '<span class="booking-badge">üìã</span>' : ''}
                                ${pilgrim.parent_id === null && state.pilgrims.some(p => p.parent_id === pilgrim.id) ? '<span class="family-badge">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>' : ''}
                                ${pilgrim.parent_id !== null ? `<span class="${pilgrim.child_type === 'CHILD' ? 'child-badge' : 'infant-badge'}">${pilgrim.child_type || '–†–ï–ë–Å–ù–û–ö'}</span>` : ''}
                            </div>
                            <div class="list-item-meta">
                                üì± ${pilgrim.phone}<br>
                                <span class="status-badge status-${pilgrim.status}">${getStatusName(pilgrim.status)}</span>
                                ${pilgrim.visa_required === 'VIZA BAR' ? 
                                    '<span class="status-badge status-viza-bar" style="margin-left: 8px;">VIZA BAR</span>' : 
                                    (hasVisa ? 
                                        '<span style="color: var(--success); margin-left: 8px;">‚úì –í–∏–∑–∞</span>' : 
                                        '<span style="color: var(--danger); margin-left: 8px;">‚úó –í–∏–∑–∞</span>')}
                                ${pilgrim.nabor_size && pilgrim.nabor_size !== 'NO' ? 
                                    `<span style="margin-left: 8px;">üëï ${pilgrim.nabor_size}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html || '<div class="placeholder"><p>–ù–µ—Ç –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤</p></div>';
        }

        function selectPilgrim(pilgrimId) {
            state.selectedPilgrimId = pilgrimId;
            renderPilgrimsList();
            renderSelectedPilgrim();
        }

        function toggleShowAll() {
            state.showAllPilgrims = !state.showAllPilgrims;
            const button = document.getElementById('showAllBtn');
            button.textContent = state.showAllPilgrims ? '–¢–æ–ª—å–∫–æ –≥—Ä—É–ø–ø—É' : '–í—Å–µ';
            renderPilgrimsList();
        }

        function renderSelectedPilgrim() {
            const container = document.getElementById('pilgrimDetail');
            const pilgrim = state.pilgrims.find(p => p.id === state.selectedPilgrimId);
            
            if (!pilgrim) {
                container.innerHTML = '<div class="placeholder"><div class="placeholder-icon">üë§</div><p>–ü–∞–ª–æ–º–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p></div>';
                return;
            }
            
            const manager = state.users.find(u => u.id === pilgrim.manager_id);
            const group = state.service_groups.find(g => g.id === pilgrim.group_id);
            const pilgrimDocs = state.documents.filter(d => d.pilgrim_id === pilgrim.id);
            const pilgrimPayments = state.payments.filter(p => p.pilgrim_id === pilgrim.id);
            
            const visaDoc = pilgrimDocs.find(d => d.type === 'visa');
            const insuranceDoc = pilgrimDocs.find(d => d.type === 'insurance');
            
            let visaStatus = pilgrim.visa_required === 'VIZA BAR' ? 
                '–ù–µ –Ω—É–∂–Ω–∞ (VIZA BAR)' : 
                (visaDoc ? (visaDoc.status === 'sent' ? '–í–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–í–∏–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞') : '–í–∏–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            
            let insuranceStatus = insuranceDoc ? '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞' : '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
            
            const totalPaidUSD = pilgrimPayments.reduce((sum, p) => sum + (p.amount_usd || 0), 0);
            const totalPaidKZT = pilgrimPayments.reduce((sum, p) => sum + (p.amount_kzt || 0), 0);
            const remainingUSD = (pilgrim.tour_price_usd || 0) - totalPaidUSD;
            
            const initials = pilgrim.latin_first_name.charAt(0) + pilgrim.latin_last_name.charAt(0);
            
            // Get roommates
            const roommates = state.pilgrims.filter(p => p.room_lead_id === pilgrim.id);
            const roomLeader = pilgrim.room_lead_id ? state.pilgrims.find(p => p.id === pilgrim.room_lead_id) : null;
            const allRoommates = pilgrim.room_lead_id === null ? 
                [pilgrim, ...roommates] : 
                [roomLeader, ...state.pilgrims.filter(p => p.room_lead_id === pilgrim.room_lead_id)];
            
            // Get booking members
            const bookingMembers = state.pilgrims.filter(p => p.booking_lead_id === pilgrim.id);
            const bookingLeader = pilgrim.booking_lead_id ? state.pilgrims.find(p => p.id === pilgrim.booking_lead_id) : null;
            const allBookingMembers = pilgrim.booking_lead_id === null ? 
                [pilgrim, ...bookingMembers] : 
                [bookingLeader, ...state.pilgrims.filter(p => p.booking_lead_id === pilgrim.booking_lead_id)];
            
            // Group booking members by room
            const bookingRooms = {};
            allBookingMembers.forEach(member => {
                const roomLeaderId = member.room_lead_id || member.id;
                if (!bookingRooms[roomLeaderId]) {
                    bookingRooms[roomLeaderId] = [];
                }
                bookingRooms[roomLeaderId].push(member);
            });
            
            // Get family relations
            const parent = pilgrim.parent_id ? state.pilgrims.find(p => p.id === pilgrim.parent_id) : null;
            const children = state.pilgrims.filter(p => p.parent_id === pilgrim.id);
            
            let html = `
                <div class="detail-card">
                    <div class="detail-header">
                        <div class="detail-avatar">${initials}</div>
                        <div class="detail-info">
                            <h3>${pilgrim.latin_first_name} ${pilgrim.latin_last_name}</h3>
                            <p>üì± ${pilgrim.phone} ‚Ä¢ WhatsApp</p>
                            <p><span class="status-badge status-${pilgrim.status}">${getStatusName(pilgrim.status)}</span>
                            ${pilgrim.room_lead_id === null ? '<span class="room-badge">üè® –õ–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã</span>' : ''}
                            ${pilgrim.booking_lead_id === null ? '<span class="booking-badge">üìã –õ–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏</span>' : ''}
                            ${pilgrim.parent_id !== null ? `<span class="${pilgrim.child_type === 'CHILD' ? 'child-badge' : 'infant-badge'}">${pilgrim.child_type || '–†–ï–ë–Å–ù–û–ö'}</span>` : ''}</p>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div style="margin-bottom: 8px;"><strong>–ì—Ä—É–ø–ø–∞:</strong> ${group?.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'}</div>
                        <div style="margin-bottom: 8px;"><strong>–î–∞—Ç—ã —Ç—É—Ä–∞:</strong> ${formatDate(pilgrim.depart_date)} - ${formatDate(pilgrim.return_date)}</div>
                        <div style="margin-bottom: 8px;"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${manager?.name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</div>
                        <div><strong>–ò–ò–ù:</strong> ${pilgrim.iin || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">–†–∞–∑–º–µ—â–µ–Ω–∏–µ (–∫–æ–º–Ω–∞—Ç–∞)</div>
            `;
            
            if (pilgrim.room_lead_id === null) {
                // Room leader
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–õ–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã</strong>
                        <div class="roommates-list">
                            <div><strong>–°–æ—Å–µ–¥–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:</strong></div>
                `;
                
                allRoommates.forEach(roommate => {
                    if (roommate.id !== pilgrim.id) {
                        html += `
                            <div class="roommate-item">
                                <span>${roommate.latin_first_name} ${roommate.latin_last_name}</span>
                                <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${roommate.id})">
                                    –û—Ç–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                        `;
                    }
                });
                
                if (roommates.length === 0) {
                    html += `<div style="color: var(--text-secondary); font-style: italic;">–ù–µ—Ç —Å–æ—Å–µ–¥–µ–π</div>`;
                }
                
                html += `</div>`;
            } else {
                // Roommate
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–°–æ—Å–µ–¥ –ø–æ –∫–æ–º–Ω–∞—Ç–µ:</strong> ${roomLeader?.latin_first_name} ${roomLeader?.latin_last_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                        <strong>–í—Å–µ –≤ –∫–æ–º–Ω–∞—Ç–µ:</strong>
                        <div class="roommates-list">
                `;
                
                allRoommates.forEach(roommate => {
                    const isCurrent = roommate.id === pilgrim.id;
                    html += `
                        <div class="roommate-item">
                            <span>${roommate.latin_first_name} ${roommate.latin_last_name} ${isCurrent ? '(–í—ã)' : ''}</span>
                            <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${roommate.id})">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `
                ${(state.currentRole === 'op' || state.currentRole === 'admin') ? `
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary btn-sm" onclick="openAddRelationsModal(${pilgrim.id}, 'roommate')">
                            + –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å–µ–¥–∞
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="openMoveRoomModal(${pilgrim.id})" style="margin-left: 8px;">
                            –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥—É—é –∫–æ–º–Ω–∞—Ç—É
                        </button>
                    </div>
                ` : ''}
            `;
            
            html += `</div></div>`;
            
            // Linked booking section
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">–°–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞</div>
            `;
            
            if (pilgrim.booking_lead_id === null) {
                // Booking leader
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–õ–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏ (–±—Ä–æ–Ω—å)</strong>
                        <div class="booking-group">
                            <strong>–í—Å–µ –ø–∞–ª–æ–º–Ω–∏–∫–∏ –≤ –∑–∞—è–≤–∫–µ (${allBookingMembers.length} —á–µ–ª.):</strong>
                `;
                
                Object.values(bookingRooms).forEach((roomPilgrims, index) => {
                    const roomLeader = roomPilgrims.find(p => p.room_lead_id === null) || roomPilgrims[0];
                    html += `
                        <div class="booking-room">
                            <strong>–ö–æ–º–Ω–∞—Ç–∞ ${index + 1}: ${roomLeader.hotel_name} (${roomLeader.room_type})</strong>
                    `;
                    
                    roomPilgrims.forEach(bookingPilgrim => {
                        html += `
                            <div class="roommate-item">
                                <span>${bookingPilgrim.latin_first_name} ${bookingPilgrim.latin_last_name}</span>
                                <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${bookingPilgrim.id})">
                                    –û—Ç–∫—Ä—ã—Ç—å
                                </button>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            } else {
                // Booking member
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–õ–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏:</strong> ${bookingLeader?.latin_first_name} ${bookingLeader?.latin_last_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                        <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${bookingLeader?.id})" style="margin-top: 8px;">
                            –û—Ç–∫—Ä—ã—Ç—å –ª–∏–¥–µ—Ä–∞ –∑–∞—è–≤–∫–∏
                        </button>
                    </div>
                `;
            }
            
            html += `
                ${(state.currentRole === 'op' || state.currentRole === 'admin') ? `
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary btn-sm" onclick="openAddRelationsModal(${pilgrim.id}, 'linked_booking')">
                            + –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞—è–≤–∫—É
                        </button>
                    </div>
                ` : ''}
            `;
            
            html += `</div></div>`;
            
            // Family section
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">–°–µ–º—å—è</div>
                    <div class="family-block">
            `;
            
            if (parent) {
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–†–æ–¥–∏—Ç–µ–ª—å:</strong> ${parent.latin_first_name} ${parent.latin_last_name}<br>
                        <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${parent.id})" style="margin-top: 8px;">
                            –û—Ç–∫—Ä—ã—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è
                        </button>
                    </div>
                `;
            }
            
            if (children.length > 0) {
                html += `<div style="margin-bottom: 12px;"><strong>–î–µ—Ç–∏:</strong></div>`;
                
                children.forEach(child => {
                    html += `
                        <div class="roommate-item">
                            <span>${child.latin_first_name} ${child.latin_last_name} 
                            <span class="${child.child_type === 'CHILD' ? 'child-badge' : 'infant-badge'}">${child.child_type || '–†–ï–ë–Å–ù–û–ö'}</span></span>
                            <button class="btn btn-sm btn-secondary" onclick="selectPilgrim(${child.id})">
                                –û—Ç–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    `;
                });
            }
            
            if (!parent && children.length === 0) {
                html += `<div style="color: var(--text-secondary); font-style: italic;">–ù–µ—Ç —Å–µ–º–µ–π–Ω—ã—Ö —Å–≤—è–∑–µ–π</div>`;
            }
            
            html += `
                ${(state.currentRole === 'op' || state.currentRole === 'admin') ? `
                    <div style="margin-top: 12px;">
                        <button class="btn btn-primary btn-sm" onclick="openAddRelationsModal(${pilgrim.id}, 'child')">
                            + –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞
                        </button>
                    </div>
                ` : ''}
            `;
            
            html += `</div></div>`;
            
            // Tour package section
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">–¢—É—Ä –ø–∞–∫–µ—Ç</div>
                    <div class="detail-row">
                        <div><strong>–û—Ç–µ–ª—å:</strong> ${pilgrim.hotel_name || '-'}</div>
                        <div><strong>–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</strong> ${pilgrim.room_type || '-'}</div>
                    </div>
                    <div class="detail-row">
                        <div><strong>–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞:</strong> ${pilgrim.transfer_type || '-'}</div>
                        <div><strong>NABOR (–æ–¥–µ–∂–¥–∞):</strong> ${pilgrim.nabor_size || 'NO'}</div>
                    </div>
                    <div><strong>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–∏–∑—ã:</strong> ${pilgrim.visa_required === 'VIZA BAR' ? '–ù–µ –Ω—É–∂–Ω–∞ (VIZA BAR)' : '–î–∞'}</div>
                    ${pilgrim.comment ? `<div style="margin-top: 8px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${pilgrim.comment}</div>` : ''}
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">–ü–∞—Å–ø–æ—Ä—Ç</div>
                    <div class="form-group">
                        <label class="form-label">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞</label>
                        <input type="text" class="form-input" id="edit_passport_number" value="${pilgrim.passport_number || ''}">
                    </div>
                    <div class="detail-row">
                        <div class="form-group">
                            <label class="form-label">–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ</label>
                            <input type="text" class="form-input" id="edit_passport_citizenship" value="${pilgrim.passport_citizenship || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                            <input type="date" class="form-input" id="edit_passport_birth_date" value="${pilgrim.passport_birth_date || ''}">
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="form-group">
                            <label class="form-label">–ü–æ–ª</label>
                            <select class="form-select" id="edit_passport_gender">
                                <option value="–ú" ${pilgrim.passport_gender === '–ú' ? 'selected' : ''}>–ú—É–∂—Å–∫–æ–π</option>
                                <option value="–ñ" ${pilgrim.passport_gender === '–ñ' ? 'selected' : ''}>–ñ–µ–Ω—Å–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</label>
                            <input type="date" class="form-input" id="edit_passport_issue_date" value="${pilgrim.passport_issue_date || ''}">
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="form-group">
                            <label class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                            <input type="date" class="form-input" id="edit_passport_expiry_date" value="${pilgrim.passport_expiry_date || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö–µ–º –≤—ã–¥–∞–Ω</label>
                            <input type="text" class="form-input" id="edit_passport_authority" value="${pilgrim.passport_authority || ''}">
                        </div>
                    </div>
                    <div class="form-checkbox">
                        <input type="checkbox" id="edit_passport_verified" ${pilgrim.passport_verified ? 'checked' : ''}>
                        <label>–ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω</label>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">–í–∏–∑–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</div>
                    <div style="margin-bottom: 12px;">
                        <strong>–°—Ç–∞—Ç—É—Å –≤–∏–∑—ã:</strong> <span style="color: ${pilgrim.visa_required === 'VIZA BAR' ? 'var(--success)' : (visaDoc && visaDoc.status === 'sent' ? 'var(--success)' : 'var(--warning)')};">${visaStatus}</span><br>
                        <strong>–°—Ç–∞—Ç—É—Å —Å—Ç—Ä–∞—Ö–æ–≤–∫–∏:</strong> <span style="color: ${insuranceDoc ? 'var(--success)' : 'var(--danger)'};">${insuranceStatus}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <button class="btn btn-sm btn-primary" onclick="uploadDocument(${pilgrim.id}, 'visa')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–∑—É</button>
                        <button class="btn btn-sm btn-primary" onclick="uploadDocument(${pilgrim.id}, 'insurance')">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∫—É</button>
                        <button class="btn btn-sm btn-secondary" onclick="uploadDocument(${pilgrim.id}, 'other')">–î—Ä—É–≥–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
                    </div>
                    <table style="width: 100%; font-size: 13px;">
                        <thead>
                            <tr>
                                <th>–¢–∏–ø</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pilgrimDocs.map(doc => {
                                const uploader = state.users.find(u => u.id === doc.uploaded_by_user_id);
                                return `
                                    <tr>
                                        <td>${getDocTypeName(doc.type)}</td>
                                        <td><span class="status-badge status-${doc.status}">${getDocStatusName(doc.status)}</span></td>
                                        <td>${formatDate(doc.uploaded_at)}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary" onclick="alert('–û—Ç–∫—Ä—ã—Ç—å: ${doc.file_url}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('') || '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</td></tr>'}
                        </tbody>
                    </table>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">–ü–ª–∞—Ç–µ–∂–∏</div>
            `;
            
            // Payment logic for booking leader vs member
            if (pilgrim.booking_lead_id === null) {
                // Booking leader - show all payments
                const allBookingPayments = allBookingMembers.flatMap(member => 
                    state.payments.filter(p => p.pilgrim_id === member.id)
                );
                const totalBookingPaidUSD = allBookingPayments.reduce((sum, p) => sum + (p.amount_usd || 0), 0);
                const totalBookingTourPrice = allBookingMembers.reduce((sum, p) => sum + (p.tour_price_usd || 0), 0);
                const totalBookingRemaining = totalBookingTourPrice - totalBookingPaidUSD;
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ (–≤—Å—è –∑–∞—è–≤–∫–∞):</strong> $${totalBookingTourPrice.toLocaleString()}<br>
                        <strong>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç—ã (–≤—Å—è –∑–∞—è–≤–∫–∞):</strong> $${totalBookingPaidUSD.toLocaleString()}<br>
                        <strong>–û—Å—Ç–∞–ª–æ—Å—å –æ–ø–ª–∞—Ç–∏—Ç—å (–≤—Å—è –∑–∞—è–≤–∫–∞):</strong> <span style="color: ${totalBookingRemaining > 0 ? 'var(--warning)' : 'var(--success)'};">$${totalBookingRemaining.toLocaleString()}</span><br>
                        <small style="color: var(--text-secondary);">–í—Å–µ–≥–æ –ø–∞–ª–æ–º–Ω–∏–∫–æ–≤ –≤ –∑–∞—è–≤–∫–µ: ${allBookingMembers.length}</small>
                    </div>
                `;
            } else {
                // Booking member - show info about leader's payment
                html += `
                    <div style="margin-bottom: 12px;">
                        <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞:</strong> $${(pilgrim.tour_price_usd || 0).toLocaleString()}<br>
                        <strong>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –ª–∏–¥–µ—Ä—É –∑–∞—è–≤–∫–∏:</strong> ${bookingLeader?.latin_first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                        <small style="color: var(--text-secondary);">–ü–ª–∞—Ç–µ–∂–∏ –≤–Ω–æ—Å—è—Ç—Å—è —á–µ—Ä–µ–∑ –ª–∏–¥–µ—Ä–∞ –∑–∞—è–≤–∫–∏</small>
                    </div>
                `;
            }
            
            html += `
                ${(state.currentRole === 'finance' || state.currentRole === 'admin') && pilgrim.booking_lead_id === null ? `
                    <button class="btn btn-sm btn-primary" onclick="openAddPaymentModal(${pilgrim.id})" style="margin-bottom: 12px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
                    </button>
                ` : ''}
                <table style="width: 100%; font-size: 13px;">
                    <thead>
                        <tr>
                            <th>–¢–∏–ø</th>
                            <th>USD</th>
                            <th>KZT</th>
                            <th>–ö—É—Ä—Å</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pilgrimPayments.map(payment => `
                            <tr>
                                <td>${payment.type === 'prepayment' ? '–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' : '–î–æ–ø–ª–∞—Ç–∞'}</td>
                                <td>$${payment.amount_usd.toLocaleString()}</td>
                                <td>${payment.amount_kzt.toLocaleString()}</td>
                                <td>${payment.exchange_rate || '-'}</td>
                                <td>${formatDate(payment.paid_at)}</td>
                                <td>${payment.comment || '-'}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π</td></tr>'}
                    </tbody>
                </table>
            </div>
            
            <div class="detail-section">
                <button class="btn btn-success" onclick="savePilgrimChanges(${pilgrim.id})">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
                ${(state.currentRole === 'op' || state.currentRole === 'admin') ? `
                    <button class="btn btn-primary" onclick="openAddRelationsModal(${pilgrim.id}, 'all')" style="margin-left: 12px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–∞–ª–æ–º–Ω–∏–∫–∞
                    </button>
                ` : ''}
            </div>
        </div>
    `;
            
            container.innerHTML = html;
        }

        function savePilgrimChanges(pilgrimId) {
            const pilgrim = state.pilgrims.find(p => p.id === pilgrimId);
            if (!pilgrim) return;
            
            pilgrim.passport_number = document.getElementById('edit_passport_number').value;
            pilgrim.passport_citizenship = document.getElementById('edit_passport_citizenship').value;
            pilgrim.passport_birth_date = document.getElementById('edit_passport_birth_date').value;
            pilgrim.passport_gender = document.getElementById('edit_passport_gender').value;
            pilgrim.passport_issue_date = document.getElementById('edit_passport_issue_date').value;
            pilgrim.passport_expiry_date = document.getElementById('edit_passport_expiry_date').value;
            pilgrim.passport_authority = document.getElementById('edit_passport_authority').value;
            pilgrim.passport_verified = document.getElementById('edit_passport_verified').checked;
            pilgrim.updated_at = new Date().toISOString();
            
            alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)');
            renderSelectedPilgrim();
        }

        function uploadDocument(pilgrimId, docType) {
            const types = {
                'visa': '–≤–∏–∑–∞',
                'insurance': '—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞',
                'other': '–¥—Ä—É–≥–æ–π –¥–æ–∫—É–º–µ–Ω—Ç'
            };
            
            const newDoc = {
                id: state.documents.length + 1,
                pilgrim_id: pilgrimId,
                type: docType === 'other' ? 'voucher' : docType,
                file_url: `${docType}_${pilgrimId}_${Date.now()}.pdf`,
                original_name: `${types[docType]}_${Date.now()}.pdf`,
                status: 'preparing',
                uploaded_by_user_id: state.users.find(u => u.role === state.currentRole)?.id || 1,
                uploaded_at: new Date().toISOString()
            };
            
            state.documents.push(newDoc);
            alert(`–î–æ–∫—É–º–µ–Ω—Ç "${types[docType]}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (—Å–∏–º—É–ª—è—Ü–∏—è)`);
            renderSelectedPilgrim();
            updateDashboard();
        }

        // Add Relations Functions
        function openAddRelationsModal(pilgrimId, relationType = 'all') {
            const pilgrim = state.pilgrims.find(p => p.id === pilgrimId);
            if (!pilgrim) return;
            
            state.currentParentId = pilgrimId;
            
            let modalHTML = '';
            
            if (relationType === 'all' || relationType === 'roommate') {
                modalHTML += `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="detail-section-title">–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å–µ–¥–∞ –≤ –Ω–æ–º–µ—Ä</div>
                        <div class="form-group">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∞–ª–æ–º–Ω–∏–∫–∞</label>
                            <select class="form-select" id="existing_roommate">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ª–æ–º–Ω–∏–∫–∞ --</option>
                                ${state.pilgrims
                                    .filter(p => p.group_id === pilgrim.group_id && p.id !== pilgrim.id && p.room_lead_id !== pilgrim.id)
                                    .map(p => `<option value="${p.id}">${p.latin_first_name} ${p.latin_last_name} (${p.room_lead_id ? '—É–∂–µ –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ' : '–±–µ–∑ –∫–æ–º–Ω–∞—Ç—ã'})</option>`)
                                    .join('')}
                            </select>
                        </div>
                        <div style="text-align: center; margin: 10px 0;">–ò–õ–ò</div>
                        <button class="btn btn-primary" onclick="openRoommateModal(${pilgrimId})" style="width: 100%;">
                            –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ—Å–µ–¥–∞
                        </button>
                    </div>
                `;
            }
            
            if (relationType === 'all' || relationType === 'linked_booking') {
                modalHTML += `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="detail-section-title">–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞—è–≤–∫—É</div>
                        <p style="margin-bottom: 12px; color: var(--text-secondary);">
                            –°–æ–∑–¥–∞—Ç—å –ø–∞–ª–æ–º–Ω–∏–∫–∞ –≤ –¥—Ä—É–≥–æ–π –∫–æ–º–Ω–∞—Ç–µ, –Ω–æ –≤ —Ç–æ–π –∂–µ –∑–∞—è–≤–∫–µ (–æ–±—â–∞—è –æ–ø–ª–∞—Ç–∞)
                        </p>
                        <button class="btn btn-primary" onclick="openLinkedBookingModal(${pilgrimId})" style="width: 100%;">
                            –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞—è–≤–∫—É
                        </button>
                    </div>
                `;
            }
            
            if (relationType === 'all' || relationType === 'child') {
                modalHTML += `
                    <div class="card" style="margin-bottom: 20px;">
                        <div class="detail-section-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–±—ë–Ω–∫–∞</div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø —Ä–µ–±—ë–Ω–∫–∞</label>
                            <select class="form-select" id="child_type_select">
                                <option value="CHILD">CHILD (2-11 –ª–µ—Ç)</option>
                                <option value="INFANT">INFANT (0-23 –º–µ—Å—è—Ü–µ–≤)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openChildModal(${pilgrimId})" style="width: 100%;">
                            –°–æ–∑–¥–∞—Ç—å —Ä–µ–±—ë–Ω–∫–∞
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('addRelationsModalBody').innerHTML = modalHTML;
            document.getElementById('addRelationsModalSaveBtn').style.display = 'none';
            
            // Show modal
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('addRelationsModal').classList.add('show');
        }

        function openRoommateModal(leaderId) {
            closeModal();
            const leader = state.pilgrims.find(p => p.id === leaderId);
            if (!leader) return;
            
            state.currentRoommateLeaderId = leaderId;
            
            document.getElementById('roommateModalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="roommate_first_name" placeholder="John" oninput="checkLatinInput(this, 'warning_roommate_first_name')">
                    <div class="warning" id="warning_roommate_first_name">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="roommate_last_name" placeholder="Doe" oninput="checkLatinInput(this, 'warning_roommate_last_name')">
                    <div class="warning" id="warning_roommate_last_name">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)</label>
                    <input type="tel" class="form-input" id="roommate_phone" placeholder="+7 777 123 45 67">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ò–ù</label>
                    <input type="text" class="form-input" id="roommate_iin" placeholder="12 —Ü–∏—Ñ—Ä">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
                    <textarea class="form-textarea" id="roommate_comment" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">NABOR (—Ä–∞–∑–º–µ—Ä –æ–¥–µ–∂–¥—ã)</label>
                    <select class="form-select" id="roommate_nabor_size">
                        ${state.settings.nabor_sizes.map(size => 
                            `<option value="${size}" ${size === leader.nabor_size ? 'selected' : ''}>${size === 'NO' ? '–ù–µ—Ç (–Ω–µ –±–µ—Ä–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç)' : size}</option>`
                        ).join('')}
                    </select>
                    <small style="color: var(--text-secondary);">–£–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–æ –æ—Ç –ª–∏–¥–µ—Ä–∞: ${leader.nabor_size}</small>
                </div>
                <div class="card" style="margin-top: 20px; padding: 16px; background: #f0f9ff;">
                    <div class="detail-section-title">–ù–∞—Å–ª–µ–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—é—Ç—Å—è)</div>
                    <div><strong>–ì—Ä—É–ø–ø–∞:</strong> ${state.service_groups.find(g => g.id === leader.group_id)?.name || '-'}</div>
                    <div><strong>–û—Ç–µ–ª—å:</strong> ${leader.hotel_name || '-'}</div>
                    <div><strong>–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</strong> ${leader.room_type || '-'}</div>
                    <div><strong>–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞:</strong> ${leader.transfer_type || '-'}</div>
                    <div><strong>–î–∞—Ç—ã —Ç—É—Ä–∞:</strong> ${formatDate(leader.depart_date)} - ${formatDate(leader.return_date)}</div>
                    <div><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${state.users.find(u => u.id === leader.manager_id)?.name || '-'}</div>
                    <div><strong>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–∏–∑—ã:</strong> ${leader.visa_required === 'VIZA BAR' ? '–ù–µ –Ω—É–∂–Ω–∞ (VIZA BAR)' : '–î–∞'}</div>
                    <div><strong>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</strong> –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ (–æ–ø–ª–∞—Ç–∞ –∑–∞ –Ω–æ–º–µ—Ä)</div>
                </div>
            `;
            
            document.getElementById('roommateModalSaveBtn').onclick = saveRoommate;
            
            // Show modal
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('roommateModal').classList.add('show');
        }

        function saveRoommate() {
            const leader = state.pilgrims.find(p => p.id === state.currentRoommateLeaderId);
            if (!leader) return;
            
            const firstName = document.getElementById('roommate_first_name').value;
            const lastName = document.getElementById('roommate_last_name').value;
            
            // Basic Latin check
            const latinRegex = /^[A-Za-z\s]+$/;
            if (!latinRegex.test(firstName) || !latinRegex.test(lastName)) {
                alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã');
                return;
            }
            
            const newRoommate = {
                id: state.pilgrims.length + 1,
                group_id: leader.group_id,
                manager_id: leader.manager_id,
                latin_first_name: firstName,
                latin_last_name: lastName,
                phone: document.getElementById('roommate_phone').value,
                iin: document.getElementById('roommate_iin').value,
                messenger: 'whatsapp',
                status: 'new',
                visa_required: leader.visa_required,
                nabor_size: document.getElementById('roommate_nabor_size').value,
                comment: document.getElementById('roommate_comment').value,
                hotel_name: leader.hotel_name,
                hotel_type: leader.hotel_type,
                room_type: leader.room_type,
                board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                transfer_type: leader.transfer_type,
                depart_date: leader.depart_date,
                return_date: leader.return_date,
                tour_price_usd: leader.tour_price_usd,
                passport_number: '',
                passport_citizenship: '',
                passport_birth_date: '',
                passport_gender: '–ú',
                passport_issue_date: '',
                passport_expiry_date: '',
                passport_authority: '',
                passport_photo_url: '',
                passport_verified: false,
                room_lead_id: leader.id,
                booking_lead_id: leader.booking_lead_id,
                parent_id: null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            state.pilgrims.push(newRoommate);
            closeModal();
            renderSelectedPilgrim();
            renderPilgrimsList();
            updateDashboard();
            alert('–°–æ—Å–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–æ–º–µ—Ä');
        }

        function openLinkedBookingModal(bookingLeaderId) {
            closeModal();
            const bookingLeader = state.pilgrims.find(p => p.id === bookingLeaderId);
            if (!bookingLeader) return;
            
            state.currentBookingLeaderId = bookingLeaderId;
            const group = state.service_groups.find(g => g.id === bookingLeader.group_id);
            const groupHotels = group.allowed_hotels && group.allowed_hotels.length > 0 ? 
                group.allowed_hotels : state.settings.hotels;
            
            document.getElementById('linkedBookingModalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="linked_first_name" placeholder="John" oninput="checkLatinInput(this, 'warning_linked_first_name')">
                    <div class="warning" id="warning_linked_first_name">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="linked_last_name" placeholder="Doe" oninput="checkLatinInput(this, 'warning_linked_last_name')">
                    <div class="warning" id="warning_linked_last_name">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)</label>
                    <input type="tel" class="form-input" id="linked_phone" placeholder="+7 777 123 45 67">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ò–ù</label>
                    <input type="text" class="form-input" id="linked_iin" placeholder="12 —Ü–∏—Ñ—Ä">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
                    <textarea class="form-textarea" id="linked_comment" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–û—Ç–µ–ª—å</label>
                        <select class="form-select" id="linked_hotel_name">
                            ${groupHotels.map(hotel => `<option value="${hotel}" ${hotel === bookingLeader.hotel_name ? 'selected' : ''}>${hotel}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</label>
                        <select class="form-select" id="linked_room_type">
                            ${state.settings.accommodation_types.map(type => 
                                `<option value="${type}" ${type === bookingLeader.room_type ? 'selected' : ''}>${type}</option>`
                            ).join('')}
                    </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞</label>
                        <select class="form-select" id="linked_transfer_type">
                            ${state.settings.transfer_types.map(type => 
                                `<option value="${type}" ${type === bookingLeader.transfer_type ? 'selected' : ''}>${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">NABOR (—Ä–∞–∑–º–µ—Ä –æ–¥–µ–∂–¥—ã)</label>
                        <select class="form-select" id="linked_nabor_size">
                            ${state.settings.nabor_sizes.map(size => `<option value="${size}">${size === 'NO' ? '–ù–µ—Ç (–Ω–µ –±–µ—Ä–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç)' : size}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–∏–∑—ã</label>
                    <select class="form-select" id="linked_visa_required">
                        <option value="YES">–î–∞ (–Ω—É–∂–Ω–∞ –≤–∏–∑–∞)</option>
                        <option value="VIZA BAR">–ù–µ –Ω—É–∂–Ω–∞ (VIZA BAR)</option>
                    </select>
                </div>
                <div class="card" style="margin-top: 20px; padding: 16px; background: #fef3c7;">
                    <div class="detail-section-title">–ù–∞—Å–ª–µ–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                    <div><strong>–ì—Ä—É–ø–ø–∞:</strong> ${group?.name || '-'}</div>
                    <div><strong>–î–∞—Ç—ã —Ç—É—Ä–∞:</strong> ${formatDate(bookingLeader.depart_date)} - ${formatDate(bookingLeader.return_date)}</div>
                    <div><strong>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</strong> <span style="color: var(--warning);">–£–∂–µ –≤–Ω–µ—Å–µ–Ω–∞ –ª–∏–¥–µ—Ä–æ–º –∑–∞—è–≤–∫–∏ ${bookingLeader.latin_first_name} ${bookingLeader.latin_last_name}</span></div>
                    <div><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ –≤ USD:</strong> <input type="number" class="form-input" id="linked_tour_price_usd" style="margin-top: 8px;" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å"></div>
                </div>
            `;
            
            document.getElementById('linkedBookingModalSaveBtn').onclick = saveLinkedBooking;
            
            // Show modal
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('linkedBookingModal').classList.add('show');
        }

        function saveLinkedBooking() {
            const bookingLeader = state.pilgrims.find(p => p.id === state.currentBookingLeaderId);
            if (!bookingLeader) return;
            
            const firstName = document.getElementById('linked_first_name').value;
            const lastName = document.getElementById('linked_last_name').value;
            
            // Basic Latin check
            const latinRegex = /^[A-Za-z\s]+$/;
            if (!latinRegex.test(firstName) || !latinRegex.test(lastName)) {
                alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã');
                return;
            }
            
            const newLinkedPilgrim = {
                id: state.pilgrims.length + 1,
                group_id: bookingLeader.group_id,
                manager_id: bookingLeader.manager_id,
                latin_first_name: firstName,
                latin_last_name: lastName,
                phone: document.getElementById('linked_phone').value,
                iin: document.getElementById('linked_iin').value,
                messenger: 'whatsapp',
                status: 'new',
                visa_required: document.getElementById('linked_visa_required').value,
                nabor_size: document.getElementById('linked_nabor_size').value,
                comment: document.getElementById('linked_comment').value,
                hotel_name: document.getElementById('linked_hotel_name').value,
                hotel_type: '5 –∑–≤–µ–∑–¥',
                room_type: document.getElementById('linked_room_type').value,
                board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                transfer_type: document.getElementById('linked_transfer_type').value,
                depart_date: bookingLeader.depart_date,
                return_date: bookingLeader.return_date,
                tour_price_usd: parseFloat(document.getElementById('linked_tour_price_usd').value) || 0,
                passport_number: '',
                passport_citizenship: '',
                passport_birth_date: '',
                passport_gender: '–ú',
                passport_issue_date: '',
                passport_expiry_date: '',
                passport_authority: '',
                passport_photo_url: '',
                passport_verified: false,
                room_lead_id: null, // –ù–æ–≤—ã–π –ª–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
                booking_lead_id: bookingLeader.id, // –í –∑–∞—è–≤–∫–µ –ª–∏–¥–µ—Ä–∞
                parent_id: null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            state.pilgrims.push(newLinkedPilgrim);
            closeModal();
            renderSelectedPilgrim();
            renderPilgrimsList();
            updateDashboard();
            alert('–°–≤—è–∑–∞–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        }

        function openChildModal(parentId) {
            closeModal();
            const parent = state.pilgrims.find(p => p.id === parentId);
            if (!parent) return;
            
            state.currentParentId = parentId;
            const group = state.service_groups.find(g => g.id === parent.group_id);
            
            document.getElementById('childModalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="child_first_name" placeholder="John" oninput="checkLatinInput(this, 'warning_child_first_name')">
                    <div class="warning" id="warning_child_first_name">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="child_last_name" placeholder="Doe" oninput="checkLatinInput(this, 'warning_child_last_name')">
                    <div class="warning" id="warning_child_last_name">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" class="form-input" id="child_birth_date">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ä–µ–±—ë–Ω–∫–∞</label>
                    <select class="form-select" id="child_type">
                        <option value="CHILD">CHILD (2-11 –ª–µ—Ç)</option>
                        <option value="INFANT">INFANT (0-23 –º–µ—Å—è—Ü–µ–≤)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ò–ù (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="child_iin" placeholder="12 —Ü–∏—Ñ—Ä">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
                    <textarea class="form-textarea" id="child_comment" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="child_same_room" checked>
                    <label>–í —Ç–æ–π –∂–µ –∫–æ–º–Ω–∞—Ç–µ —Å —Ä–æ–¥–∏—Ç–µ–ª–µ–º</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="child_passport_required">
                    <label>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Å–ø–æ—Ä—Ç</label>
                </div>
                <div class="card" style="margin-top: 20px; padding: 16px; background: #f0f9ff;">
                    <div class="detail-section-title">–ù–∞—Å–ª–µ–¥—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
                    <div><strong>–ì—Ä—É–ø–ø–∞:</strong> ${group?.name || '-'}</div>
                    <div><strong>–û—Ç–µ–ª—å:</strong> ${parent.hotel_name || '-'}</div>
                    <div><strong>–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞:</strong> ${parent.transfer_type || '-'}</div>
                    <div><strong>–î–∞—Ç—ã —Ç—É—Ä–∞:</strong> ${formatDate(parent.depart_date)} - ${formatDate(parent.return_date)}</div>
                    <div><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${state.users.find(u => u.id === parent.manager_id)?.name || '-'}</div>
                    <div><strong>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞:</strong> –£–∂–µ –≤–Ω–µ—Å–µ–Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–º</div>
                    <div><strong>NABOR (–æ–¥–µ–∂–¥–∞):</strong> <select class="form-select" id="child_nabor_size" style="margin-top: 8px;">
                        ${state.settings.nabor_sizes.map(size => `<option value="${size}">${size === 'NO' ? '–ù–µ—Ç (–Ω–µ –±–µ—Ä–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç)' : size}</option>`).join('')}
                    </select></div>
                </div>
            `;
            
            document.getElementById('childModalSaveBtn').onclick = saveChild;
            
            // Show modal
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('childModal').classList.add('show');
        }

        function saveChild() {
            const parent = state.pilgrims.find(p => p.id === state.currentParentId);
            if (!parent) return;
            
            const firstName = document.getElementById('child_first_name').value;
            const lastName = document.getElementById('child_last_name').value;
            
            // Basic Latin check
            const latinRegex = /^[A-Za-z\s]+$/;
            if (!latinRegex.test(firstName) || !latinRegex.test(lastName)) {
                alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤–∞–º–∏');
                return;
            }
            
            const sameRoom = document.getElementById('child_same_room').checked;
            
            const newChild = {
                id: state.pilgrims.length + 1,
                group_id: parent.group_id,
                manager_id: parent.manager_id,
                latin_first_name: firstName,
                latin_last_name: lastName,
                phone: parent.phone, // –û–±—ã—á–Ω–æ —É –¥–µ—Ç–µ–π –Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                iin: document.getElementById('child_iin').value,
                messenger: 'whatsapp',
                status: 'new',
                visa_required: parent.visa_required,
                nabor_size: document.getElementById('child_nabor_size').value,
                comment: document.getElementById('child_comment').value,
                hotel_name: parent.hotel_name,
                hotel_type: parent.hotel_type,
                room_type: parent.room_type,
                board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                transfer_type: parent.transfer_type,
                depart_date: parent.depart_date,
                return_date: parent.return_date,
                tour_price_usd: parent.tour_price_usd * 0.7, // –î–µ—Ç–∏ –æ–±—ã—á–Ω–æ –¥–µ—à–µ–≤–ª–µ
                passport_number: '',
                passport_citizenship: '',
                passport_birth_date: document.getElementById('child_birth_date').value,
                passport_gender: '–ú',
                passport_issue_date: '',
                passport_expiry_date: '',
                passport_authority: '',
                passport_photo_url: '',
                passport_verified: false,
                room_lead_id: sameRoom ? parent.room_lead_id || parent.id : null,
                booking_lead_id: parent.booking_lead_id,
                parent_id: parent.id,
                child_type: document.getElementById('child_type').value,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            state.pilgrims.push(newChild);
            closeModal();
            renderSelectedPilgrim();
            renderPilgrimsList();
            updateDashboard();
            alert('–†–µ–±—ë–Ω–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        function openMoveRoomModal(pilgrimId) {
            const pilgrim = state.pilgrims.find(p => p.id === pilgrimId);
            if (!pilgrim) return;
            
            document.getElementById('modalTitle').textContent = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥—É—é –∫–æ–º–Ω–∞—Ç—É';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É</label>
                    <select class="form-select" id="new_room_leader">
                        <option value="">-- –ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ (—Å—Ç–∞—Ç—å –ª–∏–¥–µ—Ä–æ–º) --</option>
                        ${state.pilgrims
                            .filter(p => p.group_id === pilgrim.group_id && p.id !== pilgrim.id)
                            .map(p => `<option value="${p.id}">${p.latin_first_name} ${p.latin_last_name} ${p.room_lead_id === null ? '(–ª–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã)' : ''}</option>`)
                            .join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É –≤ –æ—Ç–µ–ª–µ</label>
                    <select class="form-select" id="new_room_hotel">
                        ${state.settings.hotels.map(hotel => `<option value="${hotel}" ${hotel === pilgrim.hotel_name ? 'selected' : ''}>${hotel}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ</label>
                    <select class="form-select" id="new_room_type">
                        ${state.settings.accommodation_types.map(type => 
                            `<option value="${type}" ${type === pilgrim.room_type ? 'selected' : ''}>${type}</option>`
                        ).join('')}
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const newRoomLeader = document.getElementById('new_room_leader').value;
                const newHotel = document.getElementById('new_room_hotel').value;
                const newRoomType = document.getElementById('new_room_type').value;
                
                if (newRoomLeader) {
                    // Move to existing room
                    const newLeader = state.pilgrims.find(p => p.id == newRoomLeader);
                    if (newLeader) {
                        pilgrim.room_lead_id = newLeader.room_lead_id || newLeader.id;
                        pilgrim.hotel_name = newLeader.hotel_name;
                        pilgrim.room_type = newLeader.room_type;
                    }
                } else {
                    // Create new room
                    pilgrim.room_lead_id = null;
                    pilgrim.hotel_name = newHotel;
                    pilgrim.room_type = newRoomType;
                    
                    // If pilgrim had roommates, make the first one the new leader
                    const roommates = state.pilgrims.filter(p => p.room_lead_id === pilgrimId);
                    if (roommates.length > 0) {
                        const newLeader = roommates[0];
                        newLeader.room_lead_id = null;
                        roommates.slice(1).forEach(roommate => {
                            roommate.room_lead_id = newLeader.id;
                        });
                    }
                }
                
                pilgrim.updated_at = new Date().toISOString();
                closeModal();
                renderSelectedPilgrim();
                renderPilgrimsList();
                updateDashboard();
                alert('–ü–∞–ª–æ–º–Ω–∏–∫ –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –¥—Ä—É–≥—É—é –∫–æ–º–Ω–∞—Ç—É');
            };
            
            document.getElementById('modalFooter').style.display = 'flex';
            openModal();
        }

        // Templates
        function renderTemplatesPage() {
            const triggerTypes = {
                'time_before_departure': '–í—Ä–µ–º—è –¥–æ –≤—ã–ª–µ—Ç–∞',
                'time_before_arrival': '–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–ª—ë—Ç–∞',
                'document_based': '–ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞',
                'manual': '–í—Ä—É—á–Ω—É—é'
            };
            
            let html = '<table><thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞</th><th>–ö–∞–Ω–∞–ª</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            state.message_templates.forEach(template => {
                html += `
                    <tr>
                        <td>${template.name}</td>
                        <td>${triggerTypes[template.trigger_type] || template.trigger_type}</td>
                        <td>WhatsApp</td>
                        <td><span class="status-badge ${template.is_active ? 'status-sent' : 'status-new'}">${template.is_active ? '–î–∞' : '–ù–µ—Ç'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editTemplate(${template.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${template.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('templatesTable').innerHTML = html;
        }

        function editTemplate(templateId) {
            openCreateTemplateModal(templateId);
        }

        function deleteTemplate(templateId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω?')) {
                state.message_templates = state.message_templates.filter(t => t.id !== templateId);
                renderTemplatesPage();
            }
        }

        // Managers
        function renderManagersPage() {
            const roleNames = {
                'admin': '–ê–¥–º–∏–Ω',
                'service_manager': '–°–µ—Ä–≤–∏—Å',
                'op': '–û–ü',
                'finance': '–§–∏–Ω–∞–Ω—Å—ã'
            };
            
            let html = '<table><thead><tr><th>–ò–º—è</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–†–æ–ª—å</th><th>–ü–∞–ª–æ–º–Ω–∏–∫–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            state.users.forEach(user => {
                const pilgrimsCount = state.pilgrims.filter(p => p.manager_id === user.id).length;
                const paymentsCount = state.payments.filter(p => p.created_by_user_id === user.id).length;
                
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.phone}</td>
                        <td><span class="status-badge status-ready">${roleNames[user.role] || user.role}</span></td>
                        <td>${user.role === 'service_manager' || user.role === 'op' ? pilgrimsCount : user.role === 'finance' ? paymentsCount : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editManager(${user.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteManager(${user.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('managersTable').innerHTML = html;
        }

        function editManager(userId) {
            openCreateManagerModal(userId);
        }

        function deleteManager(userId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞?')) {
                state.users = state.users.filter(u => u.id !== userId);
                renderManagersPage();
            }
        }

        // Schedule
        function renderSchedulePage() {
            renderCalendar();
        }

        function renderCalendar() {
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            
            document.getElementById('calendarMonth').textContent = 
                `${monthNames[state.currentMonth]} ${state.currentYear}`;
            
            const firstDay = new Date(state.currentYear, state.currentMonth, 1);
            const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
            const startDay = firstDay.getDay() || 7; // Make Monday = 1
            
            const dayHeaders = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            let html = '';
            
            dayHeaders.forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 1; i < startDay; i++) {
                html += '<div></div>';
            }
            
            // Days of month
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${state.currentYear}-${String(state.currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasEvent = state.service_groups.some(g => 
                    g.depart_date === dateStr || g.return_date === dateStr
                ) || state.message_templates.some(t => 
                    t.trigger_type.includes('time') && t.is_active
                );
                const isSelected = state.selectedDate === dateStr;
                
                html += `
                    <div class="calendar-day ${hasEvent ? 'has-event' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectDate('${dateStr}')">
                        ${day}
                    </div>
                `;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
            
            if (state.selectedDate) {
                renderEventsPanel();
            } else {
                document.getElementById('eventsPanel').innerHTML = '<p style="color: var(--text-secondary);">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>';
            }
        }

        function selectDate(dateStr) {
            state.selectedDate = dateStr;
            renderCalendar();
        }

        function renderEventsPanel() {
            const events = [];
            
            // Find departures
            state.service_groups.forEach(group => {
                if (group.depart_date === state.selectedDate) {
                    events.push({
                        type: 'departure',
                        title: `–í—ã–ª–µ—Ç: ${group.name}`,
                        desc: `–ì—Ä—É–ø–ø–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ${group.depart_route}`
                    });
                    
                    // Find templates for before departure
                    state.message_templates.filter(t => t.trigger_type === 'time_before_departure' && t.is_active).forEach(template => {
                        const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                        events.push({
                            type: 'message',
                            title: template.name,
                            desc: `–û—Ç–ø—Ä–∞–≤–∫–∞ ${pilgrimsCount} –ø–∞–ª–æ–º–Ω–∏–∫–∞–º`
                        });
                    });
                }
                
                if (group.return_date === state.selectedDate) {
                    events.push({
                        type: 'arrival',
                        title: `–ü—Ä–∏–ª—ë—Ç: ${group.name}`,
                        desc: `–ì—Ä—É–ø–ø–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è`
                    });
                    
                    state.message_templates.filter(t => t.trigger_type === 'time_before_arrival' && t.is_active).forEach(template => {
                        const pilgrimsCount = state.pilgrims.filter(p => p.group_id === group.id).length;
                        events.push({
                            type: 'message',
                            title: template.name,
                            desc: `–û—Ç–ø—Ä–∞–≤–∫–∞ ${pilgrimsCount} –ø–∞–ª–æ–º–Ω–∏–∫–∞–º`
                        });
                    });
                }
            });
            
            let html = '';
            if (events.length === 0) {
                html = '<p style="color: var(--text-secondary);">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É</p>';
            } else {
                events.forEach(event => {
                    html += `
                        <div class="event-item">
                            <div class="event-title">${event.title}</div>
                            <div class="event-desc">${event.desc}</div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('eventsPanel').innerHTML = html;
        }

        function changeMonth(delta) {
            state.currentMonth += delta;
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            } else if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            state.selectedDate = null;
            renderCalendar();
        }

        // Documents
        function renderDocumentsPage() {
            const filterType = document.getElementById('filterDocType')?.value || '';
            const filterStatus = document.getElementById('filterDocStatus')?.value || '';
            
            let docs = state.documents;
            if (filterType) docs = docs.filter(d => d.type === filterType);
            if (filterStatus) docs = docs.filter(d => d.status === filterStatus);
            
            let html = '<table><thead><tr><th>–¢–∏–ø</th><th>–ü–∞–ª–æ–º–Ω–∏–∫</th><th>–ì—Ä—É–ø–ø–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–ö–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            docs.forEach(doc => {
                const pilgrim = state.pilgrims.find(p => p.id === doc.pilgrim_id);
                const group = state.service_groups.find(g => g.id === pilgrim?.group_id);
                const uploader = state.users.find(u => u.id === doc.uploaded_by_user_id);
                
                html += `
                    <tr>
                        <td>${getDocTypeName(doc.type)}</td>
                        <td>${pilgrim ? `${pilgrim.latin_first_name} ${pilgrim.latin_last_name}` : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>${group?.name || '-'}</td>
                        <td><span class="status-badge status-${doc.status}">${getDocStatusName(doc.status)}</span></td>
                        <td>${formatDate(doc.uploaded_at)}</td>
                        <td>${uploader?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="alert('–û—Ç–∫—Ä—ã—Ç—å: ${doc.file_url}')">–û—Ç–∫—Ä—ã—Ç—å</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('documentsTable').innerHTML = html;
        }

        // Modals
        function openModal() {
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('genericModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('genericModal').classList.remove('show');
            document.getElementById('roommateModal').classList.remove('show');
            document.getElementById('linkedBookingModal').classList.remove('show');
            document.getElementById('childModal').classList.remove('show');
            document.getElementById('addRelationsModal').classList.remove('show');
            state.currentRoommateLeaderId = null;
            state.currentBookingLeaderId = null;
            state.currentParentId = null;
        }

        function openCreateGroupModal() {
            document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –≤—ã–ª–µ—Ç–∞</label>
                    <input type="date" class="form-input" id="group_depart_date">
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞ –ø—Ä–∏–ª—ë—Ç–∞</label>
                    <input type="date" class="form-input" id="group_return_date">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–ú–∞—Ä—à—Ä—É—Ç –≤—ã–ª–µ—Ç–∞ (–∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤)</label>
                        <input type="text" class="form-input" id="group_depart_route" placeholder="ALA-JED">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ú–∞—Ä—à—Ä—É—Ç –ø—Ä–∏–ª—ë—Ç–∞ (–∫–æ–¥—ã –≥–æ—Ä–æ–¥–æ–≤)</label>
                        <input type="text" class="form-input" id="group_return_route" placeholder="MED-ALA">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–ê–≤–∏–∞–ø–µ—Ä–µ–≤–æ–∑—á–∏–∫</label>
                    <input type="text" class="form-input" id="group_airline" placeholder="AIR ASTANA">
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="group_status">
                        <option value="new">–ù–æ–≤–∞—è</option>
                        <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                        <option value="flying">–í –ø—É—Ç–∏</option>
                        <option value="in_trip">–í –ø–æ–µ–∑–¥–∫–µ</option>
                        <option value="finished">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –æ—Ç–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <select class="form-select" id="group_allowed_hotels" multiple style="height: 100px;">
                        ${state.settings.hotels.map(hotel => `<option value="${hotel}">${hotel}</option>`).join('')}
                    </select>
                    <small style="color: var(--text-secondary);">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–µ–ª–µ–π</small>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const departDate = document.getElementById('group_depart_date').value;
                const returnDate = document.getElementById('group_return_date').value;
                const departRoute = document.getElementById('group_depart_route').value;
                const returnRoute = document.getElementById('group_return_route').value;
                const airline = document.getElementById('group_airline').value;
                
                const name = `${formatDateShort(departDate)} - ${formatDateShort(returnDate)}   ${departRoute}   ${returnRoute}   ${airline}`;
                
                const selectedHotels = Array.from(document.getElementById('group_allowed_hotels').selectedOptions)
                    .map(option => option.value);
                
                const newGroup = {
                    id: state.service_groups.length + 1,
                    name: name,
                    depart_date: departDate,
                    return_date: returnDate,
                    depart_route: departRoute,
                    return_route: returnRoute,
                    airline: airline,
                    status: document.getElementById('group_status').value,
                    allowed_hotels: selectedHotels,
                    created_at: new Date().toISOString()
                };
                
                state.service_groups.push(newGroup);
                closeModal();
                renderGroupsAndPilgrims();
                updateDashboard();
                updateFilterDropdowns();
                alert('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
            };
            
            openModal();
        }

        function openCreatePilgrimModal() {
            if (!state.selectedGroupId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É');
                return;
            }
            
            const group = state.service_groups.find(g => g.id === state.selectedGroupId);
            const serviceManagers = state.users.filter(u => u.role === 'service_manager' || u.role === 'op');
            
            // Get hotels for this group (group-specific or all)
            const groupHotels = group.allowed_hotels && group.allowed_hotels.length > 0 ? 
                group.allowed_hotels : state.settings.hotels;
            
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–∞–ª–æ–º–Ω–∏–∫–∞';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="pilgrim_first_name" placeholder="John" oninput="checkLatinInput(this, 'warning_first_name')">
                    <div class="warning" id="warning_first_name">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–§–∞–º–∏–ª–∏—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                    <input type="text" class="form-input" id="pilgrim_last_name" placeholder="Doe" oninput="checkLatinInput(this, 'warning_last_name')">
                    <div class="warning" id="warning_last_name">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ª–∞—Ç–∏–Ω—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏</div>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã)</label>
                    <input type="tel" class="form-input" id="pilgrim_phone" placeholder="+7 777 123 45 67">
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ò–ù</label>
                    <input type="text" class="form-input" id="pilgrim_iin" placeholder="12 —Ü–∏—Ñ—Ä">
                </div>
                <div class="form-group">
                    <label class="form-label">–°–µ—Ä–≤–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä</label>
                    <select class="form-select" id="pilgrim_manager_id">
                        ${serviceManagers.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤–∏–∑—ã</label>
                    <select class="form-select" id="pilgrim_visa_required">
                        <option value="YES">–î–∞ (–Ω—É–∂–Ω–∞ –≤–∏–∑–∞)</option>
                        <option value="VIZA BAR">–ù–µ –Ω—É–∂–Ω–∞ (VIZA BAR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–û—Ç–µ–ª—å</label>
                    <select class="form-select" id="pilgrim_hotel_name">
                        ${groupHotels.map(hotel => `<option value="${hotel}">${hotel}</option>`).join('')}
                    </select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</label>
                        <select class="form-select" id="pilgrim_room_type">
                            ${state.settings.accommodation_types.map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä–∞</label>
                        <select class="form-select" id="pilgrim_transfer_type">
                            ${state.settings.transfer_types.map(type => `<option value="${type}">${type}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">NABOR (—Ä–∞–∑–º–µ—Ä –æ–¥–µ–∂–¥—ã)</label>
                    <select class="form-select" id="pilgrim_nabor_size">
                        ${state.settings.nabor_sizes.map(size => `<option value="${size}">${size === 'NO' ? '–ù–µ—Ç (–Ω–µ –±–µ—Ä–µ—Ç –∫–æ–º–ø–ª–µ–∫—Ç)' : size}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç—ã —Ç—É—Ä–∞ (–∏–∑ –≥—Ä—É–ø–ø—ã)</label>
                    <input type="text" class="form-input" value="${formatDate(group.depart_date)} - ${formatDate(group.return_date)}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç—É—Ä–∞ –≤ USD</label>
                    <input type="number" class="form-input" id="pilgrim_tour_price_usd">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è/–Ω—É–∂–¥—ã)</label>
                    <textarea class="form-textarea" id="pilgrim_comment" placeholder="–∏–Ω–≤ –∫–æ–ª—è—Å–∫–∞, –º–µ–¥. —É—Å–ª–æ–≤–∏—è, –æ—Å–æ–±—ã–π —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä –∏ —Ç.–¥."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Å–ø–æ—Ä—Ç (PDF)</label>
                    <input type="file" class="form-input" id="pilgrim_passport_file" accept=".pdf">
                </div>
                
                <div class="card" style="margin-top: 20px; padding: 16px;">
                    <div class="detail-section-title">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</div>
                    <div class="currency-input-group">
                        <div class="form-group">
                            <label class="form-label">–°—É–º–º–∞ –≤ KZT</label>
                            <input type="number" class="form-input" id="prepayment_kzt" placeholder="0" oninput="convertCurrency('kzt')">
                        </div>
                        <div class="currency-separator">–ø–æ –∫—É—Ä—Å—É</div>
                        <div class="form-group">
                            <label class="form-label">–ö—É—Ä—Å KZT ‚Üí USD</label>
                            <input type="number" class="form-input" id="exchange_rate" value="450" step="0.01" oninput="convertCurrency('rate')">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ –≤ USD (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)</label>
                        <input type="number" class="form-input" id="prepayment_usd_calculated" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ USD</label>
                        <input type="number" class="form-input" id="prepayment_usd_direct" placeholder="0" oninput="convertCurrency('usd')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ß–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ</label>
                        <input type="file" class="form-input" id="prepayment_receipt" accept=".pdf,.jpg,.png">
                    </div>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const firstName = document.getElementById('pilgrim_first_name').value;
                const lastName = document.getElementById('pilgrim_last_name').value;
                
                // Basic Latin check
                const latinRegex = /^[A-Za-z\s]+$/;
                if (!latinRegex.test(firstName) || !latinRegex.test(lastName)) {
                    alert('–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã');
                    return;
                }
                
                const prepaymentKZT = parseFloat(document.getElementById('prepayment_kzt').value) || 0;
                const prepaymentUSD = parseFloat(document.getElementById('prepayment_usd_direct').value) || 
                                    parseFloat(document.getElementById('prepayment_usd_calculated').value) || 0;
                const exchangeRate = parseFloat(document.getElementById('exchange_rate').value) || 450;
                
                const newPilgrim = {
                    id: state.pilgrims.length + 1,
                    group_id: state.selectedGroupId,
                    manager_id: parseInt(document.getElementById('pilgrim_manager_id').value),
                    latin_first_name: firstName,
                    latin_last_name: lastName,
                    phone: document.getElementById('pilgrim_phone').value,
                    iin: document.getElementById('pilgrim_iin').value,
                    messenger: 'whatsapp',
                    status: 'new',
                    visa_required: document.getElementById('pilgrim_visa_required').value,
                    nabor_size: document.getElementById('pilgrim_nabor_size').value,
                    comment: document.getElementById('pilgrim_comment').value,
                    hotel_name: document.getElementById('pilgrim_hotel_name').value,
                    hotel_type: '5 –∑–≤–µ–∑–¥',
                    room_type: document.getElementById('pilgrim_room_type').value,
                    board_type: '–ü–æ–ª–Ω—ã–π –ø–∞–Ω—Å–∏–æ–Ω',
                    transfer_type: document.getElementById('pilgrim_transfer_type').value,
                    depart_date: group.depart_date,
                    return_date: group.return_date,
                    tour_price_usd: parseFloat(document.getElementById('pilgrim_tour_price_usd').value) || 0,
                    passport_number: '',
                    passport_citizenship: '',
                    passport_birth_date: '',
                    passport_gender: '–ú',
                    passport_issue_date: '',
                    passport_expiry_date: '',
                    passport_authority: '',
                    passport_photo_url: '',
                    passport_verified: false,
                    room_lead_id: null, // –ù–æ–≤—ã–π –ª–∏–¥–µ—Ä –∫–æ–º–Ω–∞—Ç—ã
                    booking_lead_id: null, // –ù–æ–≤—ã–π –ª–∏–¥–µ—Ä –∑–∞—è–≤–∫–∏
                    parent_id: null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                state.pilgrims.push(newPilgrim);
                
                // Add prepayment if any
                if (prepaymentUSD > 0 || prepaymentKZT > 0) {
                    const calculatedKZT = prepaymentKZT || (prepaymentUSD * exchangeRate);
                    const calculatedUSD = prepaymentUSD || (prepaymentKZT / exchangeRate);
                    
                    state.payments.push({
                        id: state.payments.length + 1,
                        pilgrim_id: newPilgrim.id,
                        type: 'prepayment',
                        amount_usd: calculatedUSD,
                        amount_kzt: calculatedKZT,
                        exchange_rate: exchangeRate,
                        currency_source: prepaymentKZT > 0 ? 'kzt' : 'usd',
                        paid_at: new Date().toISOString().split('T')[0],
                        created_by_user_id: state.users.find(u => u.role === 'op')?.id || 3,
                        comment: '–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞'
                    });
                }
                
                // Add passport document if file was "uploaded"
                const passportFile = document.getElementById('pilgrim_passport_file').value;
                if (passportFile) {
                    state.documents.push({
                        id: state.documents.length + 1,
                        pilgrim_id: newPilgrim.id,
                        type: 'passport',
                        file_url: `passport_${newPilgrim.id}.pdf`,
                        original_name: `–ü–∞—Å–ø–æ—Ä—Ç ${firstName} ${lastName}.pdf`,
                        status: 'preparing',
                        uploaded_by_user_id: state.users.find(u => u.role === 'op')?.id || 3,
                        uploaded_at: new Date().toISOString()
                    });
                }
                
                closeModal();
                renderGroupsAndPilgrims();
                updateDashboard();
                alert('–ü–∞–ª–æ–º–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function convertCurrency(source) {
            const kztInput = document.getElementById('prepayment_kzt');
            const usdCalculated = document.getElementById('prepayment_usd_calculated');
            const usdDirect = document.getElementById('prepayment_usd_direct');
            const rateInput = document.getElementById('exchange_rate');
            
            const rate = parseFloat(rateInput.value) || 450;
            
            if (source === 'kzt') {
                const kzt = parseFloat(kztInput.value) || 0;
                const usd = kzt / rate;
                usdCalculated.value = usd.toFixed(2);
                usdDirect.value = '';
            } else if (source === 'usd') {
                const usd = parseFloat(usdDirect.value) || 0;
                const kzt = usd * rate;
                kztInput.value = kzt.toFixed(0);
                usdCalculated.value = usd.toFixed(2);
            } else if (source === 'rate') {
                const kzt = parseFloat(kztInput.value) || 0;
                const usdDirectVal = parseFloat(usdDirect.value) || 0;
                
                if (kzt > 0) {
                    const usd = kzt / rate;
                    usdCalculated.value = usd.toFixed(2);
                } else if (usdDirectVal > 0) {
                    const kzt = usdDirectVal * rate;
                    kztInput.value = kzt.toFixed(0);
                }
            }
        }

        function checkLatinInput(input, warningId) {
            const value = input.value;
            const latinRegex = /^[A-Za-z\s]*$/;
            const warning = document.getElementById(warningId);
            
            if (value && !latinRegex.test(value)) {
                warning.classList.add('show');
                input.style.borderColor = 'var(--warning)';
            } else {
                warning.classList.remove('show');
                input.style.borderColor = '';
            }
        }

        function openCreateTemplateModal(templateId = null) {
            const template = templateId ? state.message_templates.find(t => t.id === templateId) : null;
            const isEdit = !!template;
            
            document.getElementById('modalTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω' : '–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="template_name" value="${template?.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø —Ç—Ä–∏–≥–≥–µ—Ä–∞</label>
                    <select class="form-select" id="template_trigger_type" onchange="updateTriggerFields()">
                        <option value="time_before_departure" ${template?.trigger_type === 'time_before_departure' ? 'selected' : ''}>–í—Ä–µ–º—è –¥–æ –≤—ã–ª–µ—Ç–∞</option>
                        <option value="time_before_arrival" ${template?.trigger_type === 'time_before_arrival' ? 'selected' : ''}>–í—Ä–µ–º—è –¥–æ –ø—Ä–∏–ª—ë—Ç–∞</option>
                        <option value="document_based" ${template?.trigger_type === 'document_based' ? 'selected' : ''}>–ü—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</option>
                        <option value="manual" ${template?.trigger_type === 'manual' ? 'selected' : ''}>–í—Ä—É—á–Ω—É—é</option>
                    </select>
                </div>
                <div id="trigger_fields">
                    ${getTriggerFields(template)}
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                    <textarea class="form-textarea" id="template_body" placeholder="–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ {latin_first_name}, {latin_last_name}, {depart_date}, {hotel_name}, {manager_name}, {nabor_size}">${template?.body || ''}</textarea>
                    <small style="color: var(--text-secondary);">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: {latin_first_name}, {latin_last_name}, {depart_date}, {return_date}, {hotel_name}, {manager_name}, {nabor_size}, {visa_required}, {comment}</small>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="template_can_attach_file" ${template?.can_attach_file ? 'checked' : ''}>
                    <label>–ü—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —Ñ–∞–π–ª</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="template_is_active" ${template?.is_active !== false ? 'checked' : ''}>
                    <label>–ê–∫—Ç–∏–≤–µ–Ω</label>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const triggerType = document.getElementById('template_trigger_type').value;
                
                const newTemplate = {
                    id: template?.id || state.message_templates.length + 1,
                    name: document.getElementById('template_name').value,
                    trigger_type: triggerType,
                    trigger_key: triggerType.replace('time_', '').replace('_based', ''),
                    offset_days: parseInt(document.getElementById('template_offset_days')?.value) || 0,
                    offset_hours: parseInt(document.getElementById('template_offset_hours')?.value) || 0,
                    offset_minutes: parseInt(document.getElementById('template_offset_minutes')?.value) || 0,
                    document_type: document.getElementById('template_document_type')?.value || null,
                    channel: 'whatsapp',
                    body: document.getElementById('template_body').value,
                    variables: {},
                    can_attach_file: document.getElementById('template_can_attach_file').checked,
                    is_active: document.getElementById('template_is_active').checked,
                    created_at: template?.created_at || new Date().toISOString()
                };
                
                if (isEdit) {
                    const index = state.message_templates.findIndex(t => t.id === template.id);
                    state.message_templates[index] = newTemplate;
                } else {
                    state.message_templates.push(newTemplate);
                }
                
                closeModal();
                renderTemplatesPage();
                alert(isEdit ? '–®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª—ë–Ω' : '–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω');
            };
            
            openModal();
        }

        function getTriggerFields(template) {
            const triggerType = template?.trigger_type || 'time_before_departure';
            
            if (triggerType.startsWith('time_')) {
                return `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–î–Ω–µ–π –¥–æ —Å–æ–±—ã—Ç–∏—è</label>
                            <input type="number" class="form-input" id="template_offset_days" value="${template?.offset_days || -7}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ß–∞—Å–æ–≤</label>
                            <input type="number" class="form-input" id="template_offset_hours" value="${template?.offset_hours || 0}">
                        </div>
                    </div>
                    <small style="color: var(--text-secondary);">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –¥–æ —Å–æ–±—ã—Ç–∏—è</small>
                `;
            } else if (triggerType === 'document_based') {
                return `
                    <div class="form-group">
                        <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                        <select class="form-select" id="template_document_type">
                            <option value="visa" ${template?.document_type === 'visa' ? 'selected' : ''}>–í–∏–∑–∞</option>
                            <option value="insurance" ${template?.document_type === 'insurance' ? 'selected' : ''}>–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                            <option value="ticket" ${template?.document_type === 'ticket' ? 'selected' : ''}>–ë–∏–ª–µ—Ç</option>
                            <option value="voucher" ${template?.document_type === 'voucher' ? 'selected' : ''}>–í–∞—É—á–µ—Ä</option>
                            <option value="passport" ${template?.document_type === 'passport' ? 'selected' : ''}>–ü–∞—Å–ø–æ—Ä—Ç</option>
                        </select>
                    </div>
                `;
            }
            
            return '<p style="color: var(--text-secondary);">–†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è</p>';
        }

        function updateTriggerFields() {
            const triggerType = document.getElementById('template_trigger_type').value;
            document.getElementById('trigger_fields').innerHTML = getTriggerFields({ trigger_type: triggerType });
        }

        function openCreateManagerModal(userId = null) {
            const user = userId ? state.users.find(u => u.id === userId) : null;
            const isEdit = !!user;
            
            document.getElementById('modalTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞' : '–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ò–º—è</label>
                    <input type="text" class="form-input" id="manager_name" value="${user?.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-input" id="manager_phone" value="${user?.phone || ''}" placeholder="+77012345678">
                </div>
                <div class="form-group">
                    <label class="form-label">–†–æ–ª—å</label>
                    <select class="form-select" id="manager_role">
                        <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω</option>
                        <option value="service_manager" ${user?.role === 'service_manager' ? 'selected' : ''}>–°–µ—Ä–≤–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä</option>
                        <option value="op" ${user?.role === 'op' ? 'selected' : ''}>–û–ü</option>
                        <option value="finance" ${user?.role === 'finance' ? 'selected' : ''}>–§–∏–Ω–∞–Ω—Å—ã</option>
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const newUser = {
                    id: user?.id || state.users.length + 1,
                    name: document.getElementById('manager_name').value,
                    phone: document.getElementById('manager_phone').value,
                    role: document.getElementById('manager_role').value,
                    created_at: user?.created_at || new Date().toISOString()
                };
                
                if (isEdit) {
                    const index = state.users.findIndex(u => u.id === user.id);
                    state.users[index] = newUser;
                } else {
                    state.users.push(newUser);
                }
                
                closeModal();
                renderManagersPage();
                updateFilterDropdowns();
                alert(isEdit ? '–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±–Ω–æ–≤–ª—ë–Ω' : '–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function openAddPaymentModal(pilgrimId) {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞</label>
                    <select class="form-select" id="payment_type">
                        <option value="prepayment">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                        <option value="extra">–î–æ–ø–ª–∞—Ç–∞</option>
                    </select>
                </div>
                <div class="currency-input-group">
                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ –≤ KZT</label>
                        <input type="number" class="form-input" id="payment_kzt" placeholder="0" oninput="convertPaymentCurrency('kzt')">
                    </div>
                    <div class="currency-separator">–ø–æ –∫—É—Ä—Å—É</div>
                    <div class="form-group">
                        <label class="form-label">–ö—É—Ä—Å KZT ‚Üí USD</label>
                        <input type="number" class="form-input" id="payment_exchange_rate" value="450" step="0.01" oninput="convertPaymentCurrency('rate')">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞ –≤ USD (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ)</label>
                    <input type="number" class="form-input" id="payment_usd_calculated" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">–ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ USD</label>
                    <input type="number" class="form-input" id="payment_usd_direct" placeholder="0" oninput="convertPaymentCurrency('usd')">
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea class="form-textarea" id="payment_comment" placeholder="–¥–æ–ø–ª–∞—Ç–∞ –∑–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä, –æ–ø–ª–∞—Ç–∞ –∑–∞ –¥–æ–ø. –±–∞–≥–∞–∂"></textarea>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const kzt = parseFloat(document.getElementById('payment_kzt').value) || 0;
                const usdDirect = parseFloat(document.getElementById('payment_usd_direct').value) || 0;
                const usdCalculated = parseFloat(document.getElementById('payment_usd_calculated').value) || 0;
                const exchangeRate = parseFloat(document.getElementById('payment_exchange_rate').value) || 450;
                
                const finalUSD = usdDirect || usdCalculated;
                const finalKZT = kzt || (finalUSD * exchangeRate);
                
                const newPayment = {
                    id: state.payments.length + 1,
                    pilgrim_id: pilgrimId,
                    type: document.getElementById('payment_type').value,
                    amount_usd: finalUSD,
                    amount_kzt: finalKZT,
                    exchange_rate: exchangeRate,
                    currency_source: kzt > 0 ? 'kzt' : 'usd',
                    paid_at: new Date().toISOString().split('T')[0],
                    created_by_user_id: state.users.find(u => u.role === 'finance' || u.role === 'admin')?.id || 4,
                    comment: document.getElementById('payment_comment').value
                };
                
                state.payments.push(newPayment);
                closeModal();
                renderSelectedPilgrim();
                updateDashboard();
                alert('–ü–ª–∞—Ç–µ–∂ –¥–æ–±–∞–≤–ª–µ–Ω');
            };
            
            openModal();
        }

        function convertPaymentCurrency(source) {
            const kztInput = document.getElementById('payment_kzt');
            const usdCalculated = document.getElementById('payment_usd_calculated');
            const usdDirect = document.getElementById('payment_usd_direct');
            const rateInput = document.getElementById('payment_exchange_rate');
            
            const rate = parseFloat(rateInput.value) || 450;
            
            if (source === 'kzt') {
                const kzt = parseFloat(kztInput.value) || 0;
                const usd = kzt / rate;
                usdCalculated.value = usd.toFixed(2);
                usdDirect.value = '';
            } else if (source === 'usd') {
                const usd = parseFloat(usdDirect.value) || 0;
                const kzt = usd * rate;
                kztInput.value = kzt.toFixed(0);
                usdCalculated.value = usd.toFixed(2);
            } else if (source === 'rate') {
                const kzt = parseFloat(kztInput.value) || 0;
                const usdDirectVal = parseFloat(usdDirect.value) || 0;
                
                if (kzt > 0) {
                    const usd = kzt / rate;
                    usdCalculated.value = usd.toFixed(2);
                } else if (usdDirectVal > 0) {
                    const kzt = usdDirectVal * rate;
                    kztInput.value = kzt.toFixed(0);
                }
            }
        }

        function openUploadDocumentModal() {
            document.getElementById('modalTitle').textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-group">
                    <label class="form-label">–ü–∞–ª–æ–º–Ω–∏–∫</label>
                    <select class="form-select" id="doc_pilgrim_id">
                        ${state.pilgrims.map(p => `<option value="${p.id}">${p.latin_first_name} ${p.latin_last_name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                    <select class="form-select" id="doc_type">
                        <option value="passport">–ü–∞—Å–ø–æ—Ä—Ç</option>
                        <option value="visa">–í–∏–∑–∞</option>
                        <option value="insurance">–°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                        <option value="ticket">–ë–∏–ª–µ—Ç</option>
                        <option value="voucher">–í–∞—É—á–µ—Ä</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="doc_status">
                        <option value="preparing">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</option>
                        <option value="ready_to_send">–ì–æ—Ç–æ–≤–æ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ</option>
                        <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    </select>
                </div>
            `;
            
            document.getElementById('modalSaveBtn').onclick = () => {
                const type = document.getElementById('doc_type').value;
                const pilgrimId = parseInt(document.getElementById('doc_pilgrim_id').value);
                const pilgrim = state.pilgrims.find(p => p.id === pilgrimId);
                
                const newDoc = {
                    id: state.documents.length + 1,
                    pilgrim_id: pilgrimId,
                    type: type,
                    file_url: `${type}_${pilgrimId}_${Date.now()}.pdf`,
                    original_name: `${type}_${pilgrim.latin_first_name}_${pilgrim.latin_last_name}.pdf`,
                    status: document.getElementById('doc_status').value,
                    uploaded_by_user_id: state.users.find(u => u.role === state.currentRole)?.id || 1,
                    uploaded_at: new Date().toISOString()
                };
                
                state.documents.push(newDoc);
                closeModal();
                renderDocumentsPage();
                updateDashboard();
                alert('–î–æ–∫—É–º–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
            };
            
            openModal();
        }

        // Settings
        function loadSettings() {
            document.getElementById('settingsHotels').value = state.settings.hotels.join('\n');
            document.getElementById('settingsAccommodation').value = state.settings.accommodation_types.join(', ');
            document.getElementById('settingsTransfer').value = state.settings.transfer_types.join(', ');
            document.getElementById('settingsNabor').value = state.settings.nabor_sizes.join(', ');
            document.getElementById('settingsChildTypes').value = state.settings.child_types.join(', ');
        }

        function testMessengerConnection() {
            alert('–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–∏–º—É–ª—è—Ü–∏—è).\n\n–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ WhatsApp!');
        }

        function saveSettings() {
            // Save reference lists
            const hotelsText = document.getElementById('settingsHotels').value;
            state.settings.hotels = hotelsText.split('\n').filter(h => h.trim());
            
            const accommodationText = document.getElementById('settingsAccommodation').value;
            state.settings.accommodation_types = accommodationText.split(',').map(a => a.trim()).filter(a => a);
            
            const transferText = document.getElementById('settingsTransfer').value;
            state.settings.transfer_types = transferText.split(',').map(t => t.trim()).filter(t => t);
            
            const naborText = document.getElementById('settingsNabor').value;
            state.settings.nabor_sizes = naborText.split(',').map(n => n.trim()).filter(n => n);
            
            const childText = document.getElementById('settingsChildTypes').value;
            state.settings.child_types = childText.split(',').map(c => c.trim()).filter(c => c);
            
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)');
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }

        function formatDateShort(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}.${month}`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        function getStatusName(status) {
            const names = {
                'new': '–ù–æ–≤—ã–π',
                'preparing': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
                'ready': '–ì–æ—Ç–æ–≤',
                'flying': '–õ–µ—Ç–∏—Ç',
                'in_trip': '–í –ø–æ–µ–∑–¥–∫–µ',
                'in_hotel': '–í –æ—Ç–µ–ª–µ',
                'rituals': '–û–±—Ä—è–¥—ã',
                'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω',
                'training': '–û–±—É—á–µ–Ω–∏–µ'
            };
            return names[status] || status;
        }

        function getDocTypeName(type) {
            const names = {
                'passport': '–ü–∞—Å–ø–æ—Ä—Ç',
                'visa': '–í–∏–∑–∞',
                'insurance': '–°—Ç—Ä–∞—Ö–æ–≤–∫–∞',
                'ticket': '–ë–∏–ª–µ—Ç',
                'voucher': '–í–∞—É—á–µ—Ä',
                'hotel_voucher': '–í–∞—É—á–µ—Ä –æ—Ç–µ–ª—è',
                'itinerary': '–ú–∞—Ä—à—Ä—É—Ç',
                'memo': '–ü–∞–º—è—Ç–∫–∞'
            };
            return names[type] || type;
        }

        function getDocStatusName(status) {
            const names = {
                'preparing': '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
                'ready_to_send': '–ì–æ—Ç–æ–≤–æ',
                'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'
            };
            return names[status] || status;
        }

        function getTemplateName(templateId) {
            const template = state.message_templates.find(t => t.id === templateId);
            return template ? template.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω';
        }

        function updateFilterDropdowns() {
            // Update groups dropdown
            const groupSelect = document.getElementById('filterGroup');
            groupSelect.innerHTML = '<option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>' +
                state.service_groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            
            // Update managers dropdown
            const managerSelect = document.getElementById('filterManager');
            const managers = state.users.filter(u => u.role === 'service_manager' || u.role === 'op');
            managerSelect.innerHTML = '<option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>' +
                managers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', initUI);
    </script>
</body>
</html>